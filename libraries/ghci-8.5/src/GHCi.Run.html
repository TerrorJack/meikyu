<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE GADTs, RecordWildCards, MagicHash, ScopedTypeVariables, CPP,
    UnboxedTuples #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-name-shadowing #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- Execute GHCi messages.</span><span>
</span><a name="line-7"></a><span class="hs-comment">--</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- For details on Remote GHCi, see Note [Remote GHCi] in</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- compiler/ghci/GHCi.hs.</span><span>
</span><a name="line-10"></a><span class="hs-comment">--</span><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHCi</span><span class="hs-operator">.</span><span class="hs-identifier">Run</span><span>
</span><a name="line-12"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="GHCi.Run.html#run"><span class="hs-identifier hs-var">run</span></a><span class="hs-special">,</span><span> </span><a href="GHCi.Run.html#redirectInterrupts"><span class="hs-identifier hs-var">redirectInterrupts</span></a><span>
</span><a name="line-13"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="GHCi.CreateBCO.html"><span class="hs-identifier">GHCi</span><span class="hs-operator">.</span><span class="hs-identifier">CreateBCO</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="GHCi.InfoTable.html"><span class="hs-identifier">GHCi</span><span class="hs-operator">.</span><span class="hs-identifier">InfoTable</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="GHCi.FFI.html"><span class="hs-identifier">GHCi</span><span class="hs-operator">.</span><span class="hs-identifier">FFI</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="GHCi.Message.html"><span class="hs-identifier">GHCi</span><span class="hs-operator">.</span><span class="hs-identifier">Message</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="GHCi.ObjLink.html"><span class="hs-identifier">GHCi</span><span class="hs-operator">.</span><span class="hs-identifier">ObjLink</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="GHCi.RemoteTypes.html"><span class="hs-identifier">GHCi</span><span class="hs-operator">.</span><span class="hs-identifier">RemoteTypes</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="GHCi.TH.html"><span class="hs-identifier">GHCi</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="GHCi.BreakArray.html"><span class="hs-identifier">GHCi</span><span class="hs-operator">.</span><span class="hs-identifier">BreakArray</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="GHCi.StaticPtrTable.html"><span class="hs-identifier">GHCi</span><span class="hs-operator">.</span><span class="hs-identifier">StaticPtrTable</span></a><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Concurrent.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="../deepseq-1.4.3.0/src/%{MODULE/./-}.html#%{NAME}/Control.DeepSeq.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">DeepSeq</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Exception.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="../binary-0.8.5.1/src/%{MODULE/./-}.html#%{NAME}/Data.Binary.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="../binary-0.8.5.1/src/%{MODULE/./-}.html#%{NAME}/Data.Binary.Get.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Get</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span></a><span> </span><span class="hs-special">(</span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Unsafe.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Unsafe</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">B</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Exts.html"><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Exts</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Stack.html"><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Stack</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.html"><span class="hs-identifier">Foreign</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.C.html"><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">C</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Conc.Sync.html"><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Conc</span><span class="hs-operator">.</span><span class="hs-identifier">Sync</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.html"><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span></a><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.html#bracket"><span class="hs-identifier hs-var">bracket</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/System.Mem.Weak.html"><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Mem</span><span class="hs-operator">.</span><span class="hs-identifier">Weak</span></a><span>  </span><span class="hs-special">(</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Weak.html#deRefWeak"><span class="hs-identifier hs-var">deRefWeak</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Unsafe.Coerce.html"><span class="hs-identifier">Unsafe</span><span class="hs-operator">.</span><span class="hs-identifier">Coerce</span></a><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-43"></a><span class="hs-comment">-- Implement messages</span><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-identifier">run</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHCi.Message.html#Message"><span class="hs-identifier hs-type">Message</span></a><span> </span><a href="#local-6989586621679101158"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679101158"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-46"></a><a name="run"><a href="GHCi.Run.html#run"><span class="hs-identifier">run</span></a></a><span> </span><a name="local-6989586621679101159"><a href="#local-6989586621679101159"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679101159"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-47"></a><span>  </span><a href="GHCi.Message.html#InitLinker"><span class="hs-identifier hs-var">InitLinker</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.ObjLink.html#initObjLinker"><span class="hs-identifier hs-var">initObjLinker</span></a><span> </span><a href="GHCi.ObjLink.html#RetainCAFs"><span class="hs-identifier hs-var">RetainCAFs</span></a><span>
</span><a name="line-48"></a><span>  </span><a href="GHCi.Message.html#LookupSymbol"><span class="hs-identifier hs-var">LookupSymbol</span></a><span> </span><a name="local-6989586621679101160"><a href="#local-6989586621679101160"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a><span> </span><a href="GHCi.RemoteTypes.html#toRemotePtr"><span class="hs-identifier hs-var">toRemotePtr</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="GHCi.ObjLink.html#lookupSymbol"><span class="hs-identifier hs-var">lookupSymbol</span></a><span> </span><a href="#local-6989586621679101160"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-49"></a><span>  </span><a href="GHCi.Message.html#LookupClosure"><span class="hs-identifier hs-var">LookupClosure</span></a><span> </span><a name="local-6989586621679101161"><a href="#local-6989586621679101161"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.ObjLink.html#lookupClosure"><span class="hs-identifier hs-var">lookupClosure</span></a><span> </span><a href="#local-6989586621679101161"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-50"></a><span>  </span><a href="GHCi.Message.html#LoadDLL"><span class="hs-identifier hs-var">LoadDLL</span></a><span> </span><a name="local-6989586621679101162"><a href="#local-6989586621679101162"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.ObjLink.html#loadDLL"><span class="hs-identifier hs-var">loadDLL</span></a><span> </span><a href="#local-6989586621679101162"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-51"></a><span>  </span><a href="GHCi.Message.html#LoadArchive"><span class="hs-identifier hs-var">LoadArchive</span></a><span> </span><a name="local-6989586621679101163"><a href="#local-6989586621679101163"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.ObjLink.html#loadArchive"><span class="hs-identifier hs-var">loadArchive</span></a><span> </span><a href="#local-6989586621679101163"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-52"></a><span>  </span><a href="GHCi.Message.html#LoadObj"><span class="hs-identifier hs-var">LoadObj</span></a><span> </span><a name="local-6989586621679101164"><a href="#local-6989586621679101164"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.ObjLink.html#loadObj"><span class="hs-identifier hs-var">loadObj</span></a><span> </span><a href="#local-6989586621679101164"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-53"></a><span>  </span><a href="GHCi.Message.html#UnloadObj"><span class="hs-identifier hs-var">UnloadObj</span></a><span> </span><a name="local-6989586621679101165"><a href="#local-6989586621679101165"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.ObjLink.html#unloadObj"><span class="hs-identifier hs-var">unloadObj</span></a><span> </span><a href="#local-6989586621679101165"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-54"></a><span>  </span><a href="GHCi.Message.html#AddLibrarySearchPath"><span class="hs-identifier hs-var">AddLibrarySearchPath</span></a><span> </span><a name="local-6989586621679101166"><a href="#local-6989586621679101166"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.RemoteTypes.html#toRemotePtr"><span class="hs-identifier hs-var">toRemotePtr</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="GHCi.ObjLink.html#addLibrarySearchPath"><span class="hs-identifier hs-var">addLibrarySearchPath</span></a><span> </span><a href="#local-6989586621679101166"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-55"></a><span>  </span><a href="GHCi.Message.html#RemoveLibrarySearchPath"><span class="hs-identifier hs-var">RemoveLibrarySearchPath</span></a><span> </span><a name="local-6989586621679101167"><a href="#local-6989586621679101167"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.ObjLink.html#removeLibrarySearchPath"><span class="hs-identifier hs-var">removeLibrarySearchPath</span></a><span> </span><span class="hs-special">(</span><a href="GHCi.RemoteTypes.html#fromRemotePtr"><span class="hs-identifier hs-var">fromRemotePtr</span></a><span> </span><a href="#local-6989586621679101167"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span>  </span><a href="GHCi.Message.html#ResolveObjs"><span class="hs-identifier hs-var">ResolveObjs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.ObjLink.html#resolveObjs"><span class="hs-identifier hs-var">resolveObjs</span></a><span>
</span><a name="line-57"></a><span>  </span><a href="GHCi.Message.html#FindSystemLibrary"><span class="hs-identifier hs-var">FindSystemLibrary</span></a><span> </span><a name="local-6989586621679101168"><a href="#local-6989586621679101168"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.ObjLink.html#findSystemLibrary"><span class="hs-identifier hs-var">findSystemLibrary</span></a><span> </span><a href="#local-6989586621679101168"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-58"></a><span>  </span><a href="GHCi.Message.html#CreateBCOs"><span class="hs-identifier hs-var">CreateBCOs</span></a><span> </span><a name="local-6989586621679101169"><a href="#local-6989586621679101169"><span class="hs-identifier">bcos</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.CreateBCO.html#createBCOs"><span class="hs-identifier hs-var">createBCOs</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a><span> </span><span class="hs-special">(</span><a href="../binary-0.8.5.1/src/%{MODULE/./-}.html#%{NAME}/Data.Binary.Get.html#runGet"><span class="hs-identifier hs-var">runGet</span></a><span> </span><a href="../binary-0.8.5.1/src/%{MODULE/./-}.html#%{NAME}/Data.Binary.Class.html#get"><span class="hs-identifier hs-var">get</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679101169"><span class="hs-identifier hs-var">bcos</span></a><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span>  </span><a href="GHCi.Message.html#FreeHValueRefs"><span class="hs-identifier hs-var">FreeHValueRefs</span></a><span> </span><a name="local-6989586621679101170"><a href="#local-6989586621679101170"><span class="hs-identifier">rs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="GHCi.RemoteTypes.html#freeRemoteRef"><span class="hs-identifier hs-var">freeRemoteRef</span></a><span> </span><a href="#local-6989586621679101170"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-60"></a><span>  </span><a href="GHCi.Message.html#AddSptEntry"><span class="hs-identifier hs-var">AddSptEntry</span></a><span> </span><a name="local-6989586621679101171"><a href="#local-6989586621679101171"><span class="hs-identifier">fpr</span></a></a><span> </span><a name="local-6989586621679101172"><a href="#local-6989586621679101172"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.RemoteTypes.html#localRef"><span class="hs-identifier hs-var">localRef</span></a><span> </span><a href="#local-6989586621679101172"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a><span> </span><a href="GHCi.StaticPtrTable.html#sptAddEntry"><span class="hs-identifier hs-var">sptAddEntry</span></a><span> </span><a href="#local-6989586621679101171"><span class="hs-identifier hs-var">fpr</span></a><span>
</span><a name="line-61"></a><span>  </span><a href="GHCi.Message.html#EvalStmt"><span class="hs-identifier hs-var">EvalStmt</span></a><span> </span><a name="local-6989586621679101173"><a href="#local-6989586621679101173"><span class="hs-identifier">opts</span></a></a><span> </span><a name="local-6989586621679101174"><a href="#local-6989586621679101174"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.Run.html#evalStmt"><span class="hs-identifier hs-var">evalStmt</span></a><span> </span><a href="#local-6989586621679101173"><span class="hs-identifier hs-var">opts</span></a><span> </span><a href="#local-6989586621679101174"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-62"></a><span>  </span><a href="GHCi.Message.html#ResumeStmt"><span class="hs-identifier hs-var">ResumeStmt</span></a><span> </span><a name="local-6989586621679101175"><a href="#local-6989586621679101175"><span class="hs-identifier">opts</span></a></a><span> </span><a name="local-6989586621679101176"><a href="#local-6989586621679101176"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.Run.html#resumeStmt"><span class="hs-identifier hs-var">resumeStmt</span></a><span> </span><a href="#local-6989586621679101175"><span class="hs-identifier hs-var">opts</span></a><span> </span><a href="#local-6989586621679101176"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-63"></a><span>  </span><a href="GHCi.Message.html#AbandonStmt"><span class="hs-identifier hs-var">AbandonStmt</span></a><span> </span><a name="local-6989586621679101177"><a href="#local-6989586621679101177"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.Run.html#abandonStmt"><span class="hs-identifier hs-var">abandonStmt</span></a><span> </span><a href="#local-6989586621679101177"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-64"></a><span>  </span><a href="GHCi.Message.html#EvalString"><span class="hs-identifier hs-var">EvalString</span></a><span> </span><a name="local-6989586621679101178"><a href="#local-6989586621679101178"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.Run.html#evalString"><span class="hs-identifier hs-var">evalString</span></a><span> </span><a href="#local-6989586621679101178"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-65"></a><span>  </span><a href="GHCi.Message.html#EvalStringToString"><span class="hs-identifier hs-var">EvalStringToString</span></a><span> </span><a name="local-6989586621679101179"><a href="#local-6989586621679101179"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621679101180"><a href="#local-6989586621679101180"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.Run.html#evalStringToString"><span class="hs-identifier hs-var">evalStringToString</span></a><span> </span><a href="#local-6989586621679101179"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679101180"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-66"></a><span>  </span><a href="GHCi.Message.html#EvalIO"><span class="hs-identifier hs-var">EvalIO</span></a><span> </span><a name="local-6989586621679101181"><a href="#local-6989586621679101181"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.Run.html#evalIO"><span class="hs-identifier hs-var">evalIO</span></a><span> </span><a href="#local-6989586621679101181"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-67"></a><span>  </span><a href="GHCi.Message.html#MkCostCentres"><span class="hs-identifier hs-var">MkCostCentres</span></a><span> </span><a name="local-6989586621679101182"><a href="#local-6989586621679101182"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621679101183"><a href="#local-6989586621679101183"><span class="hs-identifier">ccs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.Run.html#mkCostCentres"><span class="hs-identifier hs-var">mkCostCentres</span></a><span> </span><a href="#local-6989586621679101182"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621679101183"><span class="hs-identifier hs-var">ccs</span></a><span>
</span><a name="line-68"></a><span>  </span><a href="GHCi.Message.html#CostCentreStackInfo"><span class="hs-identifier hs-var">CostCentreStackInfo</span></a><span> </span><a name="local-6989586621679101184"><a href="#local-6989586621679101184"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Stack.CCS.html#ccsToStrings"><span class="hs-identifier hs-var">ccsToStrings</span></a><span> </span><span class="hs-special">(</span><a href="GHCi.RemoteTypes.html#fromRemotePtr"><span class="hs-identifier hs-var">fromRemotePtr</span></a><span> </span><a href="#local-6989586621679101184"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span>  </span><a href="GHCi.Message.html#NewBreakArray"><span class="hs-identifier hs-var">NewBreakArray</span></a><span> </span><a name="local-6989586621679101185"><a href="#local-6989586621679101185"><span class="hs-identifier">sz</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.RemoteTypes.html#mkRemoteRef"><span class="hs-identifier hs-var">mkRemoteRef</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%3D%3C%3C"><span class="hs-operator hs-var">=&lt;&lt;</span></a><span> </span><a href="GHCi.BreakArray.html#newBreakArray"><span class="hs-identifier hs-var">newBreakArray</span></a><span> </span><a href="#local-6989586621679101185"><span class="hs-identifier hs-var">sz</span></a><span>
</span><a name="line-70"></a><span>  </span><a href="GHCi.Message.html#EnableBreakpoint"><span class="hs-identifier hs-var">EnableBreakpoint</span></a><span> </span><a name="local-6989586621679101186"><a href="#local-6989586621679101186"><span class="hs-identifier">ref</span></a></a><span> </span><a name="local-6989586621679101187"><a href="#local-6989586621679101187"><span class="hs-identifier">ix</span></a></a><span> </span><a name="local-6989586621679101188"><a href="#local-6989586621679101188"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-71"></a><span>    </span><a name="local-6989586621679101189"><a href="#local-6989586621679101189"><span class="hs-identifier">arr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.RemoteTypes.html#localRef"><span class="hs-identifier hs-var">localRef</span></a><span> </span><a href="#local-6989586621679101186"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-72"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679101188"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="GHCi.BreakArray.html#setBreakOn"><span class="hs-identifier hs-var">setBreakOn</span></a><span> </span><a href="#local-6989586621679101189"><span class="hs-identifier hs-var">arr</span></a><span> </span><a href="#local-6989586621679101187"><span class="hs-identifier hs-var">ix</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="GHCi.BreakArray.html#setBreakOff"><span class="hs-identifier hs-var">setBreakOff</span></a><span> </span><a href="#local-6989586621679101189"><span class="hs-identifier hs-var">arr</span></a><span> </span><a href="#local-6989586621679101187"><span class="hs-identifier hs-var">ix</span></a><span>
</span><a name="line-73"></a><span>    </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>  </span><a href="GHCi.Message.html#BreakpointStatus"><span class="hs-identifier hs-var">BreakpointStatus</span></a><span> </span><a name="local-6989586621679101190"><a href="#local-6989586621679101190"><span class="hs-identifier">ref</span></a></a><span> </span><a name="local-6989586621679101191"><a href="#local-6989586621679101191"><span class="hs-identifier">ix</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-75"></a><span>    </span><a name="local-6989586621679101192"><a href="#local-6989586621679101192"><span class="hs-identifier">arr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.RemoteTypes.html#localRef"><span class="hs-identifier hs-var">localRef</span></a><span> </span><a href="#local-6989586621679101190"><span class="hs-identifier hs-var">ref</span></a><span class="hs-special">;</span><span> </span><a name="local-6989586621679101193"><a href="#local-6989586621679101193"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.BreakArray.html#getBreak"><span class="hs-identifier hs-var">getBreak</span></a><span> </span><a href="#local-6989586621679101192"><span class="hs-identifier hs-var">arr</span></a><span> </span><a href="#local-6989586621679101191"><span class="hs-identifier hs-var">ix</span></a><span>
</span><a name="line-76"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679101193"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-77"></a><span>      </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-78"></a><span>      </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679101194"><a href="#local-6989586621679101194"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679101194"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>  </span><a href="GHCi.Message.html#GetBreakpointVar"><span class="hs-identifier hs-var">GetBreakpointVar</span></a><span> </span><a name="local-6989586621679101195"><a href="#local-6989586621679101195"><span class="hs-identifier">ref</span></a></a><span> </span><a name="local-6989586621679101196"><a href="#local-6989586621679101196"><span class="hs-identifier">ix</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-80"></a><span>    </span><a name="local-6989586621679101197"><a href="#local-6989586621679101197"><span class="hs-identifier">aps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.RemoteTypes.html#localRef"><span class="hs-identifier hs-var">localRef</span></a><span> </span><a href="#local-6989586621679101195"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-81"></a><span>    </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="GHCi.RemoteTypes.html#mkRemoteRef"><span class="hs-identifier hs-var">mkRemoteRef</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%3D%3C%3C"><span class="hs-operator hs-var">=&lt;&lt;</span></a><span> </span><a href="GHCi.Run.html#getIdValFromApStack"><span class="hs-identifier hs-var">getIdValFromApStack</span></a><span> </span><a href="#local-6989586621679101197"><span class="hs-identifier hs-var">aps</span></a><span> </span><a href="#local-6989586621679101196"><span class="hs-identifier hs-var">ix</span></a><span>
</span><a name="line-82"></a><span>  </span><a href="GHCi.Message.html#MallocData"><span class="hs-identifier hs-var">MallocData</span></a><span> </span><a name="local-6989586621679101198"><a href="#local-6989586621679101198"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.Run.html#mkString"><span class="hs-identifier hs-var">mkString</span></a><span> </span><a href="#local-6989586621679101198"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-83"></a><span>  </span><a href="GHCi.Message.html#MallocStrings"><span class="hs-identifier hs-var">MallocStrings</span></a><span> </span><a name="local-6989586621679101199"><a href="#local-6989586621679101199"><span class="hs-identifier">bss</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="GHCi.Run.html#mkString0"><span class="hs-identifier hs-var">mkString0</span></a><span> </span><a href="#local-6989586621679101199"><span class="hs-identifier hs-var">bss</span></a><span>
</span><a name="line-84"></a><span>  </span><a href="GHCi.Message.html#PrepFFI"><span class="hs-identifier hs-var">PrepFFI</span></a><span> </span><a name="local-6989586621679101200"><a href="#local-6989586621679101200"><span class="hs-identifier">conv</span></a></a><span> </span><a name="local-6989586621679101201"><a href="#local-6989586621679101201"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621679101202"><a href="#local-6989586621679101202"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.RemoteTypes.html#toRemotePtr"><span class="hs-identifier hs-var">toRemotePtr</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="GHCi.FFI.html#prepForeignCall"><span class="hs-identifier hs-var">prepForeignCall</span></a><span> </span><a href="#local-6989586621679101200"><span class="hs-identifier hs-var">conv</span></a><span> </span><a href="#local-6989586621679101201"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621679101202"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-85"></a><span>  </span><a href="GHCi.Message.html#FreeFFI"><span class="hs-identifier hs-var">FreeFFI</span></a><span> </span><a name="local-6989586621679101203"><a href="#local-6989586621679101203"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.FFI.html#freeForeignCallInfo"><span class="hs-identifier hs-var">freeForeignCallInfo</span></a><span> </span><span class="hs-special">(</span><a href="GHCi.RemoteTypes.html#fromRemotePtr"><span class="hs-identifier hs-var">fromRemotePtr</span></a><span> </span><a href="#local-6989586621679101203"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>  </span><a href="GHCi.Message.html#MkConInfoTable"><span class="hs-identifier hs-var">MkConInfoTable</span></a><span> </span><a name="local-6989586621679101204"><a href="#local-6989586621679101204"><span class="hs-identifier">ptrs</span></a></a><span> </span><a name="local-6989586621679101205"><a href="#local-6989586621679101205"><span class="hs-identifier">nptrs</span></a></a><span> </span><a name="local-6989586621679101206"><a href="#local-6989586621679101206"><span class="hs-identifier">tag</span></a></a><span> </span><a name="local-6989586621679101207"><a href="#local-6989586621679101207"><span class="hs-identifier">ptrtag</span></a></a><span> </span><a name="local-6989586621679101208"><a href="#local-6989586621679101208"><span class="hs-identifier">desc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-87"></a><span>    </span><a href="GHCi.RemoteTypes.html#toRemotePtr"><span class="hs-identifier hs-var">toRemotePtr</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="GHCi.InfoTable.html#mkConInfoTable"><span class="hs-identifier hs-var">mkConInfoTable</span></a><span> </span><a href="#local-6989586621679101204"><span class="hs-identifier hs-var">ptrs</span></a><span> </span><a href="#local-6989586621679101205"><span class="hs-identifier hs-var">nptrs</span></a><span> </span><a href="#local-6989586621679101206"><span class="hs-identifier hs-var">tag</span></a><span> </span><a href="#local-6989586621679101207"><span class="hs-identifier hs-var">ptrtag</span></a><span> </span><a href="#local-6989586621679101208"><span class="hs-identifier hs-var">desc</span></a><span>
</span><a name="line-88"></a><span>  </span><a href="GHCi.Message.html#StartTH"><span class="hs-identifier hs-var">StartTH</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.TH.html#startTH"><span class="hs-identifier hs-var">startTH</span></a><span>
</span><a name="line-89"></a><span>  </span><a name="local-6989586621679101209"><a href="#local-6989586621679101209"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a><span> </span><span class="hs-string">&quot;GHCi.Run.run&quot;</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span class="hs-identifier">evalStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHCi.Message.html#EvalOpts"><span class="hs-identifier hs-type">EvalOpts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.Message.html#EvalExpr"><span class="hs-identifier hs-type">EvalExpr</span></a><span> </span><a href="GHCi.RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#EvalStatus"><span class="hs-identifier hs-type">EvalStatus</span></a><span> </span><span class="hs-special">[</span><a href="GHCi.RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-92"></a><a name="evalStmt"><a href="GHCi.Run.html#evalStmt"><span class="hs-identifier">evalStmt</span></a></a><span> </span><a name="local-6989586621679101210"><a href="#local-6989586621679101210"><span class="hs-identifier">opts</span></a></a><span> </span><a name="local-6989586621679101211"><a href="#local-6989586621679101211"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-93"></a><span>  </span><a name="local-6989586621679101218"><a href="#local-6989586621679101218"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679101212"><span class="hs-identifier hs-var">mkIO</span></a><span> </span><a href="#local-6989586621679101211"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-94"></a><span>  </span><a href="GHCi.Run.html#sandboxIO"><span class="hs-identifier hs-var">sandboxIO</span></a><span> </span><a href="#local-6989586621679101210"><span class="hs-identifier hs-var">opts</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-95"></a><span>    </span><a name="local-6989586621679101219"><a href="#local-6989586621679101219"><span class="hs-identifier">rs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Unsafe.Coerce.html#unsafeCoerce"><span class="hs-identifier hs-var">unsafeCoerce</span></a><span> </span><a href="#local-6989586621679101218"><span class="hs-identifier hs-var">io</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><a href="GHCi.RemoteTypes.html#HValue"><span class="hs-identifier hs-type">HValue</span></a><span class="hs-special">]</span><span>
</span><a name="line-96"></a><span>    </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="GHCi.RemoteTypes.html#mkRemoteRef"><span class="hs-identifier hs-var">mkRemoteRef</span></a><span> </span><a href="#local-6989586621679101219"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-97"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-98"></a><span>  </span><a name="local-6989586621679101212"><a href="#local-6989586621679101212"><span class="hs-identifier">mkIO</span></a></a><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#EvalThis"><span class="hs-identifier hs-var">EvalThis</span></a><span> </span><a name="local-6989586621679101213"><a href="#local-6989586621679101213"><span class="hs-identifier">href</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.RemoteTypes.html#localRef"><span class="hs-identifier hs-var">localRef</span></a><span> </span><a href="#local-6989586621679101213"><span class="hs-identifier hs-var">href</span></a><span>
</span><a name="line-99"></a><span>  </span><span class="hs-identifier">mkIO</span><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#EvalApp"><span class="hs-identifier hs-var">EvalApp</span></a><span> </span><a name="local-6989586621679101214"><a href="#local-6989586621679101214"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679101215"><a href="#local-6989586621679101215"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-100"></a><span>    </span><a name="local-6989586621679101216"><a href="#local-6989586621679101216"><span class="hs-identifier">l'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679101212"><span class="hs-identifier hs-var">mkIO</span></a><span> </span><a href="#local-6989586621679101214"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-101"></a><span>    </span><a name="local-6989586621679101217"><a href="#local-6989586621679101217"><span class="hs-identifier">r'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679101212"><span class="hs-identifier hs-var">mkIO</span></a><span> </span><a href="#local-6989586621679101215"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-102"></a><span>    </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Unsafe.Coerce.html#unsafeCoerce"><span class="hs-identifier hs-var">unsafeCoerce</span></a><span> </span><a href="#local-6989586621679101216"><span class="hs-identifier hs-var">l'</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHCi.RemoteTypes.html#HValue"><span class="hs-identifier hs-type">HValue</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.RemoteTypes.html#HValue"><span class="hs-identifier hs-type">HValue</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679101217"><span class="hs-identifier hs-var">r'</span></a><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-identifier">evalIO</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHCi.RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#EvalResult"><span class="hs-identifier hs-type">EvalResult</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-105"></a><a name="evalIO"><a href="GHCi.Run.html#evalIO"><span class="hs-identifier">evalIO</span></a></a><span> </span><a name="local-6989586621679101220"><a href="#local-6989586621679101220"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-106"></a><span>  </span><a name="local-6989586621679101221"><a href="#local-6989586621679101221"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.RemoteTypes.html#localRef"><span class="hs-identifier hs-var">localRef</span></a><span> </span><a href="#local-6989586621679101220"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-107"></a><span>  </span><a href="GHCi.Run.html#tryEval"><span class="hs-identifier hs-var">tryEval</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Unsafe.Coerce.html#unsafeCoerce"><span class="hs-identifier hs-var">unsafeCoerce</span></a><span> </span><a href="#local-6989586621679101221"><span class="hs-identifier hs-var">io</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span class="hs-identifier">evalString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHCi.RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#EvalResult"><span class="hs-identifier hs-type">EvalResult</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">)</span><span>
</span><a name="line-110"></a><a name="evalString"><a href="GHCi.Run.html#evalString"><span class="hs-identifier">evalString</span></a></a><span> </span><a name="local-6989586621679101222"><a href="#local-6989586621679101222"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-111"></a><span>  </span><a name="local-6989586621679101223"><a href="#local-6989586621679101223"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.RemoteTypes.html#localRef"><span class="hs-identifier hs-var">localRef</span></a><span> </span><a href="#local-6989586621679101222"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-112"></a><span>  </span><a href="GHCi.Run.html#tryEval"><span class="hs-identifier hs-var">tryEval</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-113"></a><span>    </span><a name="local-6989586621679101224"><a href="#local-6989586621679101224"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Unsafe.Coerce.html#unsafeCoerce"><span class="hs-identifier hs-var">unsafeCoerce</span></a><span> </span><a href="#local-6989586621679101223"><span class="hs-identifier hs-var">io</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span>
</span><a name="line-114"></a><span>    </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.html#evaluate"><span class="hs-identifier hs-var">evaluate</span></a><span> </span><span class="hs-special">(</span><a href="../deepseq-1.4.3.0/src/%{MODULE/./-}.html#%{NAME}/Control.DeepSeq.html#force"><span class="hs-identifier hs-var">force</span></a><span> </span><a href="#local-6989586621679101224"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span class="hs-identifier">evalStringToString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHCi.RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#EvalResult"><span class="hs-identifier hs-type">EvalResult</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">)</span><span>
</span><a name="line-117"></a><a name="evalStringToString"><a href="GHCi.Run.html#evalStringToString"><span class="hs-identifier">evalStringToString</span></a></a><span> </span><a name="local-6989586621679101225"><a href="#local-6989586621679101225"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621679101226"><a href="#local-6989586621679101226"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-118"></a><span>  </span><a name="local-6989586621679101227"><a href="#local-6989586621679101227"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.RemoteTypes.html#localRef"><span class="hs-identifier hs-var">localRef</span></a><span> </span><a href="#local-6989586621679101225"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-119"></a><span>  </span><a href="GHCi.Run.html#tryEval"><span class="hs-identifier hs-var">tryEval</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-120"></a><span>    </span><a name="local-6989586621679101228"><a href="#local-6989586621679101228"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Unsafe.Coerce.html#unsafeCoerce"><span class="hs-identifier hs-var">unsafeCoerce</span></a><span> </span><a href="#local-6989586621679101227"><span class="hs-identifier hs-var">io</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679101226"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-121"></a><span>    </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.html#evaluate"><span class="hs-identifier hs-var">evaluate</span></a><span> </span><span class="hs-special">(</span><a href="../deepseq-1.4.3.0/src/%{MODULE/./-}.html#%{NAME}/Control.DeepSeq.html#force"><span class="hs-identifier hs-var">force</span></a><span> </span><a href="#local-6989586621679101228"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span class="hs-comment">-- When running a computation, we redirect ^C exceptions to the running</span><span>
</span><a name="line-124"></a><span class="hs-comment">-- thread.  ToDo: we might want a way to continue even if the target</span><span>
</span><a name="line-125"></a><span class="hs-comment">-- thread doesn't die when it receives the exception... &quot;this thread</span><span>
</span><a name="line-126"></a><span class="hs-comment">-- is not responding&quot;.</span><span>
</span><a name="line-127"></a><span class="hs-comment">--</span><span>
</span><a name="line-128"></a><span class="hs-comment">-- Careful here: there may be ^C exceptions flying around, so we start the new</span><span>
</span><a name="line-129"></a><span class="hs-comment">-- thread blocked (forkIO inherits mask from the parent, #1048), and unblock</span><span>
</span><a name="line-130"></a><span class="hs-comment">-- only while we execute the user's code.  We can't afford to lose the final</span><span>
</span><a name="line-131"></a><span class="hs-comment">-- putMVar, otherwise deadlock ensues. (#1583, #1922, #1946)</span><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span class="hs-identifier">sandboxIO</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHCi.Message.html#EvalOpts"><span class="hs-identifier hs-type">EvalOpts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679101157"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#EvalStatus"><span class="hs-identifier hs-type">EvalStatus</span></a><span> </span><a href="#local-6989586621679101157"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-134"></a><a name="sandboxIO"><a href="GHCi.Run.html#sandboxIO"><span class="hs-identifier">sandboxIO</span></a></a><span> </span><a name="local-6989586621679101229"><a href="#local-6989586621679101229"><span class="hs-identifier">opts</span></a></a><span> </span><a name="local-6989586621679101230"><a href="#local-6989586621679101230"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-135"></a><span>  </span><span class="hs-comment">-- We are running in uninterruptibleMask</span><span>
</span><a name="line-136"></a><span>  </span><a name="local-6989586621679101231"><a href="#local-6989586621679101231"><span class="hs-identifier">breakMVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.MVar.html#newEmptyMVar"><span class="hs-identifier hs-var">newEmptyMVar</span></a><span>
</span><a name="line-137"></a><span>  </span><a name="local-6989586621679101232"><a href="#local-6989586621679101232"><span class="hs-identifier">statusMVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.MVar.html#newEmptyMVar"><span class="hs-identifier hs-var">newEmptyMVar</span></a><span>
</span><a name="line-138"></a><span>  </span><a href="GHCi.Run.html#withBreakAction"><span class="hs-identifier hs-var">withBreakAction</span></a><span> </span><a href="#local-6989586621679101229"><span class="hs-identifier hs-var">opts</span></a><span> </span><a href="#local-6989586621679101231"><span class="hs-identifier hs-var">breakMVar</span></a><span> </span><a href="#local-6989586621679101232"><span class="hs-identifier hs-var">statusMVar</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-139"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679101233"><a href="#local-6989586621679101233"><span class="hs-identifier">runIt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.Run.html#measureAlloc"><span class="hs-identifier hs-var">measureAlloc</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHCi.Run.html#tryEval"><span class="hs-identifier hs-var">tryEval</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHCi.Run.html#rethrow"><span class="hs-identifier hs-var">rethrow</span></a><span> </span><a href="#local-6989586621679101229"><span class="hs-identifier hs-var">opts</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Stack.CCS.html#clearCCS"><span class="hs-identifier hs-var">clearCCS</span></a><span> </span><a href="#local-6989586621679101230"><span class="hs-identifier hs-var">io</span></a><span>
</span><a name="line-140"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">useSandboxThread</span><span> </span><a href="#local-6989586621679101229"><span class="hs-identifier hs-var">opts</span></a><span>
</span><a name="line-141"></a><span>       </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-142"></a><span>         </span><a name="local-6989586621679101234"><a href="#local-6989586621679101234"><span class="hs-identifier">tid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Conc.Sync.html#forkIO"><span class="hs-identifier hs-var">forkIO</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.html#unsafeUnmask"><span class="hs-identifier hs-var">unsafeUnmask</span></a><span> </span><a href="#local-6989586621679101233"><span class="hs-identifier hs-var">runIt</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679101232"><span class="hs-identifier hs-var">statusMVar</span></a><span>
</span><a name="line-143"></a><span>                                </span><span class="hs-comment">-- empty: can't block</span><span>
</span><a name="line-144"></a><span>         </span><a href="GHCi.Run.html#redirectInterrupts"><span class="hs-identifier hs-var">redirectInterrupts</span></a><span> </span><a href="#local-6989586621679101234"><span class="hs-identifier hs-var">tid</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.html#unsafeUnmask"><span class="hs-identifier hs-var">unsafeUnmask</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="#local-6989586621679101232"><span class="hs-identifier hs-var">statusMVar</span></a><span>
</span><a name="line-145"></a><span>       </span><span class="hs-keyword">else</span><span>
</span><a name="line-146"></a><span>          </span><span class="hs-comment">-- GLUT on OS X needs to run on the main thread. If you</span><span>
</span><a name="line-147"></a><span>          </span><span class="hs-comment">-- try to use it from another thread then you just get a</span><span>
</span><a name="line-148"></a><span>          </span><span class="hs-comment">-- white rectangle rendered. For this, or anything else</span><span>
</span><a name="line-149"></a><span>          </span><span class="hs-comment">-- with such restrictions, you can turn the GHCi sandbox off</span><span>
</span><a name="line-150"></a><span>          </span><span class="hs-comment">-- and things will be run in the main thread.</span><span>
</span><a name="line-151"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-152"></a><span>          </span><span class="hs-comment">-- BUT, note that the debugging features (breakpoints,</span><span>
</span><a name="line-153"></a><span>          </span><span class="hs-comment">-- tracing, etc.) need the expression to be running in a</span><span>
</span><a name="line-154"></a><span>          </span><span class="hs-comment">-- separate thread, so debugging is only enabled when</span><span>
</span><a name="line-155"></a><span>          </span><span class="hs-comment">-- using the sandbox.</span><span>
</span><a name="line-156"></a><span>         </span><a href="#local-6989586621679101233"><span class="hs-identifier hs-var">runIt</span></a><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span class="hs-comment">-- We want to turn ^C into a break when -fbreak-on-exception is on,</span><span>
</span><a name="line-159"></a><span class="hs-comment">-- but it's an async exception and we only break for sync exceptions.</span><span>
</span><a name="line-160"></a><span class="hs-comment">-- Idea: if we catch and re-throw it, then the re-throw will trigger</span><span>
</span><a name="line-161"></a><span class="hs-comment">-- a break.  Great - but we don't want to re-throw all exceptions, because</span><span>
</span><a name="line-162"></a><span class="hs-comment">-- then we'll get a double break for ordinary sync exceptions (you'd have</span><span>
</span><a name="line-163"></a><span class="hs-comment">-- to :continue twice, which looks strange).  So if the exception is</span><span>
</span><a name="line-164"></a><span class="hs-comment">-- not &quot;Interrupted&quot;, we unset the exception flag before throwing.</span><span>
</span><a name="line-165"></a><span class="hs-comment">--</span><span>
</span><a name="line-166"></a><span class="hs-identifier">rethrow</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHCi.Message.html#EvalOpts"><span class="hs-identifier hs-type">EvalOpts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679101156"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679101156"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-167"></a><a name="rethrow"><a href="GHCi.Run.html#rethrow"><span class="hs-identifier">rethrow</span></a></a><span> </span><a href="GHCi.Message.html#EvalOpts"><span class="hs-identifier hs-var">EvalOpts</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679101239"><a href="#local-6989586621679101239"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-168"></a><span>  </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.html#catch"><span class="hs-identifier hs-var">catch</span></a><span> </span><a href="#local-6989586621679101239"><span class="hs-identifier hs-var">io</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679101240"><a href="#local-6989586621679101240"><span class="hs-identifier">se</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-169"></a><span>    </span><span class="hs-comment">-- If -fbreak-on-error, we break unconditionally,</span><span>
</span><a name="line-170"></a><span>    </span><span class="hs-comment">--  but with care of not breaking twice</span><span>
</span><a name="line-171"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679101238"><span class="hs-identifier hs-var">breakOnError</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679101237"><span class="hs-identifier hs-var">breakOnException</span></a><span>
</span><a name="line-172"></a><span>       </span><span class="hs-keyword">then</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Storable.html#poke"><span class="hs-identifier hs-var">poke</span></a><span> </span><a href="GHCi.Run.html#exceptionFlag"><span class="hs-identifier hs-var">exceptionFlag</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-173"></a><span>       </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Exception.html#fromException"><span class="hs-identifier hs-var">fromException</span></a><span> </span><a href="#local-6989586621679101240"><span class="hs-identifier hs-var">se</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-174"></a><span>               </span><span class="hs-comment">-- If it is a &quot;UserInterrupt&quot; exception, we allow</span><span>
</span><a name="line-175"></a><span>               </span><span class="hs-comment">--  a possible break by way of -fbreak-on-exception</span><span>
</span><a name="line-176"></a><span>               </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.Exception.html#UserInterrupt"><span class="hs-identifier hs-var">UserInterrupt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-177"></a><span>               </span><span class="hs-comment">-- In any other case, we don't want to break</span><span>
</span><a name="line-178"></a><span>               </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Storable.html#poke"><span class="hs-identifier hs-var">poke</span></a><span> </span><a href="GHCi.Run.html#exceptionFlag"><span class="hs-identifier hs-var">exceptionFlag</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-179"></a><span>    </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.html#throwIO"><span class="hs-identifier hs-var">throwIO</span></a><span> </span><a href="#local-6989586621679101240"><span class="hs-identifier hs-var">se</span></a><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-comment">--</span><span>
</span><a name="line-182"></a><span class="hs-comment">-- While we're waiting for the sandbox thread to return a result, if</span><span>
</span><a name="line-183"></a><span class="hs-comment">-- the current thread receives an asynchronous exception we re-throw</span><span>
</span><a name="line-184"></a><span class="hs-comment">-- it at the sandbox thread and continue to wait.</span><span>
</span><a name="line-185"></a><span class="hs-comment">--</span><span>
</span><a name="line-186"></a><span class="hs-comment">-- This is for two reasons:</span><span>
</span><a name="line-187"></a><span class="hs-comment">--</span><span>
</span><a name="line-188"></a><span class="hs-comment">--  * So that ^C interrupts runStmt (e.g. in GHCi), allowing the</span><span>
</span><a name="line-189"></a><span class="hs-comment">--    computation to run its exception handlers before returning the</span><span>
</span><a name="line-190"></a><span class="hs-comment">--    exception result to the caller of runStmt.</span><span>
</span><a name="line-191"></a><span class="hs-comment">--</span><span>
</span><a name="line-192"></a><span class="hs-comment">--  * clients of the GHC API can terminate a runStmt in progress</span><span>
</span><a name="line-193"></a><span class="hs-comment">--    without knowing the ThreadId of the sandbox thread (#1381)</span><span>
</span><a name="line-194"></a><span class="hs-comment">--</span><span>
</span><a name="line-195"></a><span class="hs-comment">-- NB. use a weak pointer to the thread, so that the thread can still</span><span>
</span><a name="line-196"></a><span class="hs-comment">-- be considered deadlocked by the RTS and sent a BlockedIndefinitely</span><span>
</span><a name="line-197"></a><span class="hs-comment">-- exception.  A symptom of getting this wrong is that conc033(ghci)</span><span>
</span><a name="line-198"></a><span class="hs-comment">-- will hang.</span><span>
</span><a name="line-199"></a><span class="hs-comment">--</span><span>
</span><a name="line-200"></a><span class="hs-identifier">redirectInterrupts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Conc.Sync.html#ThreadId"><span class="hs-identifier hs-type">ThreadId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679101155"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679101155"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-201"></a><a name="redirectInterrupts"><a href="GHCi.Run.html#redirectInterrupts"><span class="hs-identifier">redirectInterrupts</span></a></a><span> </span><a name="local-6989586621679101241"><a href="#local-6989586621679101241"><span class="hs-identifier">target</span></a></a><span> </span><a name="local-6989586621679101242"><a href="#local-6989586621679101242"><span class="hs-identifier">wait</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-202"></a><span>  </span><a name="local-6989586621679101243"><a href="#local-6989586621679101243"><span class="hs-identifier">wtid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Conc.Sync.html#mkWeakThreadId"><span class="hs-identifier hs-var">mkWeakThreadId</span></a><span> </span><a href="#local-6989586621679101241"><span class="hs-identifier hs-var">target</span></a><span>
</span><a name="line-203"></a><span>  </span><a href="#local-6989586621679101242"><span class="hs-identifier hs-var">wait</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.html#catch"><span class="hs-identifier hs-var">catch</span></a><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679101244"><a href="#local-6989586621679101244"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-204"></a><span>     </span><a name="local-6989586621679101245"><a href="#local-6989586621679101245"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Weak.html#deRefWeak"><span class="hs-identifier hs-var">deRefWeak</span></a><span> </span><a href="#local-6989586621679101243"><span class="hs-identifier hs-var">wtid</span></a><span>
</span><a name="line-205"></a><span>     </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679101245"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-206"></a><span>       </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679101242"><span class="hs-identifier hs-var">wait</span></a><span>
</span><a name="line-207"></a><span>       </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679101246"><a href="#local-6989586621679101246"><span class="hs-identifier">target</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Conc.Sync.html#throwTo"><span class="hs-identifier hs-var">throwTo</span></a><span> </span><a href="#local-6989586621679101246"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679101244"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Exception.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a><span class="hs-special">)</span><span class="hs-special">;</span><span> </span><a href="#local-6989586621679101242"><span class="hs-identifier hs-var">wait</span></a><span>
</span><a name="line-208"></a><span>
</span><a name="line-209"></a><span class="hs-identifier">measureAlloc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#EvalResult"><span class="hs-identifier hs-type">EvalResult</span></a><span> </span><a href="#local-6989586621679101154"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#EvalStatus"><span class="hs-identifier hs-type">EvalStatus</span></a><span> </span><a href="#local-6989586621679101154"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-210"></a><a name="measureAlloc"><a href="GHCi.Run.html#measureAlloc"><span class="hs-identifier">measureAlloc</span></a></a><span> </span><a name="local-6989586621679101247"><a href="#local-6989586621679101247"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-211"></a><span>  </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Conc.Sync.html#setAllocationCounter"><span class="hs-identifier hs-var">setAllocationCounter</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Enum.html#maxBound"><span class="hs-identifier hs-var">maxBound</span></a><span>
</span><a name="line-212"></a><span>  </span><a name="local-6989586621679101248"><a href="#local-6989586621679101248"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679101247"><span class="hs-identifier hs-var">io</span></a><span>
</span><a name="line-213"></a><span>  </span><a name="local-6989586621679101249"><a href="#local-6989586621679101249"><span class="hs-identifier">ctr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Conc.Sync.html#getAllocationCounter"><span class="hs-identifier hs-var">getAllocationCounter</span></a><span>
</span><a name="line-214"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679101250"><a href="#local-6989586621679101250"><span class="hs-identifier">allocs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Enum.html#maxBound"><span class="hs-identifier hs-var">maxBound</span></a><span class="hs-glyph">::</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Int.html#Int64"><span class="hs-identifier hs-type">Int64</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679101249"><span class="hs-identifier hs-var">ctr</span></a><span>
</span><a name="line-215"></a><span>  </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#EvalComplete"><span class="hs-identifier hs-var">EvalComplete</span></a><span> </span><a href="#local-6989586621679101250"><span class="hs-identifier hs-var">allocs</span></a><span> </span><a href="#local-6989586621679101248"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span class="hs-comment">-- Exceptions can't be marshaled because they're dynamically typed, so</span><span>
</span><a name="line-218"></a><span class="hs-comment">-- everything becomes a String.</span><span>
</span><a name="line-219"></a><span class="hs-identifier">tryEval</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679101153"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#EvalResult"><span class="hs-identifier hs-type">EvalResult</span></a><span> </span><a href="#local-6989586621679101153"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-220"></a><a name="tryEval"><a href="GHCi.Run.html#tryEval"><span class="hs-identifier">tryEval</span></a></a><span> </span><a name="local-6989586621679101251"><a href="#local-6989586621679101251"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-221"></a><span>  </span><a name="local-6989586621679101571"><a href="#local-6989586621679101571"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Exception.Base.html#try"><span class="hs-identifier hs-var">try</span></a><span> </span><a href="#local-6989586621679101251"><span class="hs-identifier hs-var">io</span></a><span>
</span><a name="line-222"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679101571"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-223"></a><span>    </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a><span> </span><a name="local-6989586621679101572"><a href="#local-6989586621679101572"><span class="hs-identifier">ex</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#EvalException"><span class="hs-identifier hs-var">EvalException</span></a><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#toSerializableException"><span class="hs-identifier hs-var">toSerializableException</span></a><span> </span><a href="#local-6989586621679101572"><span class="hs-identifier hs-var">ex</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>    </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a><span> </span><a name="local-6989586621679101573"><a href="#local-6989586621679101573"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#EvalSuccess"><span class="hs-identifier hs-var">EvalSuccess</span></a><span> </span><a href="#local-6989586621679101573"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span class="hs-comment">-- This function sets up the interpreter for catching breakpoints, and</span><span>
</span><a name="line-227"></a><span class="hs-comment">-- resets everything when the computation has stopped running.  This</span><span>
</span><a name="line-228"></a><span class="hs-comment">-- is a not-very-good way to ensure that only the interactive</span><span>
</span><a name="line-229"></a><span class="hs-comment">-- evaluation should generate breakpoints.</span><span>
</span><a name="line-230"></a><span class="hs-identifier">withBreakAction</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHCi.Message.html#EvalOpts"><span class="hs-identifier hs-type">EvalOpts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#EvalStatus"><span class="hs-identifier hs-type">EvalStatus</span></a><span> </span><a href="#local-6989586621679101151"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679101152"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679101152"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-231"></a><a name="withBreakAction"><a href="GHCi.Run.html#withBreakAction"><span class="hs-identifier">withBreakAction</span></a></a><span> </span><a name="local-6989586621679101574"><a href="#local-6989586621679101574"><span class="hs-identifier">opts</span></a></a><span> </span><a name="local-6989586621679101575"><a href="#local-6989586621679101575"><span class="hs-identifier">breakMVar</span></a></a><span> </span><a name="local-6989586621679101576"><a href="#local-6989586621679101576"><span class="hs-identifier">statusMVar</span></a></a><span> </span><a name="local-6989586621679101577"><a href="#local-6989586621679101577"><span class="hs-identifier">act</span></a></a><span>
</span><a name="line-232"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Exception.Base.html#bracket"><span class="hs-identifier hs-var">bracket</span></a><span> </span><a href="#local-6989586621679101578"><span class="hs-identifier hs-var">setBreakAction</span></a><span> </span><a href="#local-6989586621679101580"><span class="hs-identifier hs-var">resetBreakAction</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679101577"><span class="hs-identifier hs-var">act</span></a><span class="hs-special">)</span><span>
</span><a name="line-233"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-234"></a><span>   </span><a name="local-6989586621679101578"><a href="#local-6989586621679101578"><span class="hs-identifier">setBreakAction</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-235"></a><span>     </span><a name="local-6989586621679101581"><a href="#local-6989586621679101581"><span class="hs-identifier">stablePtr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Stable.html#newStablePtr"><span class="hs-identifier hs-var">newStablePtr</span></a><span> </span><a href="#local-6989586621679101579"><span class="hs-identifier hs-var">onBreak</span></a><span>
</span><a name="line-236"></a><span>     </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Storable.html#poke"><span class="hs-identifier hs-var">poke</span></a><span> </span><a href="GHCi.Run.html#breakPointIOAction"><span class="hs-identifier hs-var">breakPointIOAction</span></a><span> </span><a href="#local-6989586621679101581"><span class="hs-identifier hs-var">stablePtr</span></a><span>
</span><a name="line-237"></a><span>     </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">breakOnException</span><span> </span><a href="#local-6989586621679101574"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Storable.html#poke"><span class="hs-identifier hs-var">poke</span></a><span> </span><a href="GHCi.Run.html#exceptionFlag"><span class="hs-identifier hs-var">exceptionFlag</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-238"></a><span>     </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">singleStep</span><span> </span><a href="#local-6989586621679101574"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHCi.Run.html#setStepFlag"><span class="hs-identifier hs-var">setStepFlag</span></a><span>
</span><a name="line-239"></a><span>     </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679101581"><span class="hs-identifier hs-var">stablePtr</span></a><span>
</span><a name="line-240"></a><span>        </span><span class="hs-comment">-- Breaking on exceptions is not enabled by default, since it</span><span>
</span><a name="line-241"></a><span>        </span><span class="hs-comment">-- might be a bit surprising.  The exception flag is turned off</span><span>
</span><a name="line-242"></a><span>        </span><span class="hs-comment">-- as soon as it is hit, or in resetBreakAction below.</span><span>
</span><a name="line-243"></a><span>
</span><a name="line-244"></a><span>   </span><span class="hs-identifier">onBreak</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHCi.Run.html#BreakpointCallback"><span class="hs-identifier hs-type">BreakpointCallback</span></a><span>
</span><a name="line-245"></a><span>   </span><a name="local-6989586621679101579"><a href="#local-6989586621679101579"><span class="hs-identifier">onBreak</span></a></a><span> </span><a name="local-6989586621679101582"><a href="#local-6989586621679101582"><span class="hs-identifier">ix</span><span class="hs-operator">#</span></a></a><span> </span><a name="local-6989586621679101583"><a href="#local-6989586621679101583"><span class="hs-identifier">uniq</span><span class="hs-operator">#</span></a></a><span> </span><a name="local-6989586621679101584"><a href="#local-6989586621679101584"><span class="hs-identifier">is_exception</span></a></a><span> </span><a name="local-6989586621679101585"><a href="#local-6989586621679101585"><span class="hs-identifier">apStack</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-246"></a><span>     </span><a name="local-6989586621679101586"><a href="#local-6989586621679101586"><span class="hs-identifier">tid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Conc.Sync.html#myThreadId"><span class="hs-identifier hs-var">myThreadId</span></a><span>
</span><a name="line-247"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679101587"><a href="#local-6989586621679101587"><span class="hs-identifier">resume</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.Message.html#ResumeContext"><span class="hs-identifier hs-var">ResumeContext</span></a><span>
</span><a name="line-248"></a><span>           </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">resumeBreakMVar</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679101575"><span class="hs-identifier hs-var">breakMVar</span></a><span>
</span><a name="line-249"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeStatusMVar</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679101576"><span class="hs-identifier hs-var">statusMVar</span></a><span>
</span><a name="line-250"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeThreadId</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679101586"><span class="hs-identifier hs-var">tid</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-251"></a><span>     </span><a name="local-6989586621679101588"><a href="#local-6989586621679101588"><span class="hs-identifier">resume_r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.RemoteTypes.html#mkRemoteRef"><span class="hs-identifier hs-var">mkRemoteRef</span></a><span> </span><a href="#local-6989586621679101587"><span class="hs-identifier hs-var">resume</span></a><span>
</span><a name="line-252"></a><span>     </span><a name="local-6989586621679101589"><a href="#local-6989586621679101589"><span class="hs-identifier">apStack_r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.RemoteTypes.html#mkRemoteRef"><span class="hs-identifier hs-var">mkRemoteRef</span></a><span> </span><a href="#local-6989586621679101585"><span class="hs-identifier hs-var">apStack</span></a><span>
</span><a name="line-253"></a><span>     </span><a name="local-6989586621679101590"><a href="#local-6989586621679101590"><span class="hs-identifier">ccs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.RemoteTypes.html#toRemotePtr"><span class="hs-identifier hs-var">toRemotePtr</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Stack.CCS.html#getCCSOf"><span class="hs-identifier hs-var">getCCSOf</span></a><span> </span><a href="#local-6989586621679101585"><span class="hs-identifier hs-var">apStack</span></a><span>
</span><a name="line-254"></a><span>     </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679101576"><span class="hs-identifier hs-var">statusMVar</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHCi.Message.html#EvalBreak"><span class="hs-identifier hs-var">EvalBreak</span></a><span> </span><a href="#local-6989586621679101584"><span class="hs-identifier hs-var">is_exception</span></a><span> </span><a href="#local-6989586621679101589"><span class="hs-identifier hs-var">apStack_r</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I</span><span class="hs-operator hs-var">#</span><span> </span><a href="#local-6989586621679101582"><span class="hs-identifier hs-var">ix</span><span class="hs-operator hs-var">#</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I</span><span class="hs-operator hs-var">#</span><span> </span><a href="#local-6989586621679101583"><span class="hs-identifier hs-var">uniq</span><span class="hs-operator hs-var">#</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679101588"><span class="hs-identifier hs-var">resume_r</span></a><span> </span><a href="#local-6989586621679101590"><span class="hs-identifier hs-var">ccs</span></a><span>
</span><a name="line-255"></a><span>     </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="#local-6989586621679101575"><span class="hs-identifier hs-var">breakMVar</span></a><span>
</span><a name="line-256"></a><span>
</span><a name="line-257"></a><span>   </span><a name="local-6989586621679101580"><a href="#local-6989586621679101580"><span class="hs-identifier">resetBreakAction</span></a></a><span> </span><a name="local-6989586621679101591"><a href="#local-6989586621679101591"><span class="hs-identifier">stablePtr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-258"></a><span>     </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Storable.html#poke"><span class="hs-identifier hs-var">poke</span></a><span> </span><a href="GHCi.Run.html#breakPointIOAction"><span class="hs-identifier hs-var">breakPointIOAction</span></a><span> </span><a href="GHCi.Run.html#noBreakStablePtr"><span class="hs-identifier hs-var">noBreakStablePtr</span></a><span>
</span><a name="line-259"></a><span>     </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Storable.html#poke"><span class="hs-identifier hs-var">poke</span></a><span> </span><a href="GHCi.Run.html#exceptionFlag"><span class="hs-identifier hs-var">exceptionFlag</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-260"></a><span>     </span><a href="GHCi.Run.html#resetStepFlag"><span class="hs-identifier hs-var">resetStepFlag</span></a><span>
</span><a name="line-261"></a><span>     </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Stable.html#freeStablePtr"><span class="hs-identifier hs-var">freeStablePtr</span></a><span> </span><a href="#local-6989586621679101591"><span class="hs-identifier hs-var">stablePtr</span></a><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-identifier">resumeStmt</span><span>
</span><a name="line-264"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="GHCi.Message.html#EvalOpts"><span class="hs-identifier hs-type">EvalOpts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.RemoteTypes.html#RemoteRef"><span class="hs-identifier hs-type">RemoteRef</span></a><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#ResumeContext"><span class="hs-identifier hs-type">ResumeContext</span></a><span> </span><span class="hs-special">[</span><a href="GHCi.RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-265"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#EvalStatus"><span class="hs-identifier hs-type">EvalStatus</span></a><span> </span><span class="hs-special">[</span><a href="GHCi.RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-266"></a><a name="resumeStmt"><a href="GHCi.Run.html#resumeStmt"><span class="hs-identifier">resumeStmt</span></a></a><span> </span><a name="local-6989586621679101592"><a href="#local-6989586621679101592"><span class="hs-identifier">opts</span></a></a><span> </span><a name="local-6989586621679101593"><a href="#local-6989586621679101593"><span class="hs-identifier">hvref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-267"></a><span>  </span><a href="GHCi.Message.html#ResumeContext"><span class="hs-identifier hs-var">ResumeContext</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.RemoteTypes.html#localRef"><span class="hs-identifier hs-var">localRef</span></a><span> </span><a href="#local-6989586621679101593"><span class="hs-identifier hs-var">hvref</span></a><span>
</span><a name="line-268"></a><span>  </span><a href="GHCi.Run.html#withBreakAction"><span class="hs-identifier hs-var">withBreakAction</span></a><span> </span><a href="#local-6989586621679101592"><span class="hs-identifier hs-var">opts</span></a><span> </span><a href="#local-6989586621679101594"><span class="hs-identifier hs-var">resumeBreakMVar</span></a><span> </span><a href="#local-6989586621679101595"><span class="hs-identifier hs-var">resumeStatusMVar</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-269"></a><span>    </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-270"></a><span>      </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679101594"><span class="hs-identifier hs-var">resumeBreakMVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- this awakens the stopped thread...</span><span>
</span><a name="line-271"></a><span>      </span><a href="GHCi.Run.html#redirectInterrupts"><span class="hs-identifier hs-var">redirectInterrupts</span></a><span> </span><a href="#local-6989586621679101596"><span class="hs-identifier hs-var">resumeThreadId</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="#local-6989586621679101595"><span class="hs-identifier hs-var">resumeStatusMVar</span></a><span>
</span><a name="line-272"></a><span>
</span><a name="line-273"></a><span class="hs-comment">-- when abandoning a computation we have to</span><span>
</span><a name="line-274"></a><span class="hs-comment">--      (a) kill the thread with an async exception, so that the</span><span>
</span><a name="line-275"></a><span class="hs-comment">--          computation itself is stopped, and</span><span>
</span><a name="line-276"></a><span class="hs-comment">--      (b) fill in the MVar.  This step is necessary because any</span><span>
</span><a name="line-277"></a><span class="hs-comment">--          thunks that were under evaluation will now be updated</span><span>
</span><a name="line-278"></a><span class="hs-comment">--          with the partial computation, which still ends in takeMVar,</span><span>
</span><a name="line-279"></a><span class="hs-comment">--          so any attempt to evaluate one of these thunks will block</span><span>
</span><a name="line-280"></a><span class="hs-comment">--          unless we fill in the MVar.</span><span>
</span><a name="line-281"></a><span class="hs-comment">--      (c) wait for the thread to terminate by taking its status MVar.  This</span><span>
</span><a name="line-282"></a><span class="hs-comment">--          step is necessary to prevent race conditions with</span><span>
</span><a name="line-283"></a><span class="hs-comment">--          -fbreak-on-exception (see #5975).</span><span>
</span><a name="line-284"></a><span class="hs-comment">--  See test break010.</span><span>
</span><a name="line-285"></a><span class="hs-identifier">abandonStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHCi.RemoteTypes.html#RemoteRef"><span class="hs-identifier hs-type">RemoteRef</span></a><span> </span><span class="hs-special">(</span><a href="GHCi.Message.html#ResumeContext"><span class="hs-identifier hs-type">ResumeContext</span></a><span> </span><span class="hs-special">[</span><a href="GHCi.RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-286"></a><a name="abandonStmt"><a href="GHCi.Run.html#abandonStmt"><span class="hs-identifier">abandonStmt</span></a></a><span> </span><a name="local-6989586621679101597"><a href="#local-6989586621679101597"><span class="hs-identifier">hvref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-287"></a><span>  </span><a href="GHCi.Message.html#ResumeContext"><span class="hs-identifier hs-var">ResumeContext</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.RemoteTypes.html#localRef"><span class="hs-identifier hs-var">localRef</span></a><span> </span><a href="#local-6989586621679101597"><span class="hs-identifier hs-var">hvref</span></a><span>
</span><a name="line-288"></a><span>  </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Conc.Sync.html#killThread"><span class="hs-identifier hs-var">killThread</span></a><span> </span><a href="#local-6989586621679101600"><span class="hs-identifier hs-var">resumeThreadId</span></a><span>
</span><a name="line-289"></a><span>  </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679101598"><span class="hs-identifier hs-var">resumeBreakMVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-290"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="#local-6989586621679101599"><span class="hs-identifier hs-var">resumeStatusMVar</span></a><span>
</span><a name="line-291"></a><span>  </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-string">&quot;&amp;rts_stop_next_breakpoint&quot;</span><span> </span><span class="hs-identifier">stepFlag</span><span>      </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span>
</span><a name="line-294"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-string">&quot;&amp;rts_stop_on_exception&quot;</span><span>    </span><span class="hs-identifier">exceptionFlag</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span class="hs-identifier">setStepFlag</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-297"></a><a name="setStepFlag"><a href="GHCi.Run.html#setStepFlag"><span class="hs-identifier">setStepFlag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Storable.html#poke"><span class="hs-identifier hs-var">poke</span></a><span> </span><a href="GHCi.Run.html#stepFlag"><span class="hs-identifier hs-var">stepFlag</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-298"></a><span class="hs-identifier">resetStepFlag</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-299"></a><a name="resetStepFlag"><a href="GHCi.Run.html#resetStepFlag"><span class="hs-identifier">resetStepFlag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Storable.html#poke"><span class="hs-identifier hs-var">poke</span></a><span> </span><a href="GHCi.Run.html#stepFlag"><span class="hs-identifier hs-var">stepFlag</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span class="hs-keyword">type</span><span> </span><a name="BreakpointCallback"><a href="GHCi.Run.html#BreakpointCallback"><span class="hs-identifier">BreakpointCallback</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-operator hs-type">#</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-operator hs-type">#</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.RemoteTypes.html#HValue"><span class="hs-identifier hs-type">HValue</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-string">&quot;&amp;rts_breakpoint_io_action&quot;</span><span>
</span><a name="line-304"></a><span>   </span><span class="hs-identifier">breakPointIOAction</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Stable.html#StablePtr"><span class="hs-identifier hs-type">StablePtr</span></a><span> </span><a href="GHCi.Run.html#BreakpointCallback"><span class="hs-identifier hs-type">BreakpointCallback</span></a><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>
</span><a name="line-306"></a><span class="hs-identifier">noBreakStablePtr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Stable.html#StablePtr"><span class="hs-identifier hs-type">StablePtr</span></a><span> </span><a href="GHCi.Run.html#BreakpointCallback"><span class="hs-identifier hs-type">BreakpointCallback</span></a><span>
</span><a name="line-307"></a><a name="noBreakStablePtr"><a href="GHCi.Run.html#noBreakStablePtr"><span class="hs-identifier">noBreakStablePtr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.Unsafe.html#unsafePerformIO"><span class="hs-identifier hs-var">unsafePerformIO</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Stable.html#newStablePtr"><span class="hs-identifier hs-var">newStablePtr</span></a><span> </span><a href="GHCi.Run.html#noBreakAction"><span class="hs-identifier hs-var">noBreakAction</span></a><span>
</span><a name="line-308"></a><span>
</span><a name="line-309"></a><span class="hs-identifier">noBreakAction</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHCi.Run.html#BreakpointCallback"><span class="hs-identifier hs-type">BreakpointCallback</span></a><span>
</span><a name="line-310"></a><a name="noBreakAction"><a href="GHCi.Run.html#noBreakAction"><span class="hs-identifier">noBreakAction</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/System.IO.html#putStrLn"><span class="hs-identifier hs-var">putStrLn</span></a><span> </span><span class="hs-string">&quot;*** Ignoring breakpoint&quot;</span><span>
</span><a name="line-311"></a><span class="hs-identifier">noBreakAction</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- exception: just continue</span><span>
</span><a name="line-312"></a><span>
</span><a name="line-313"></a><span class="hs-comment">-- Malloc and copy the bytes.  We don't have any way to monitor the</span><span>
</span><a name="line-314"></a><span class="hs-comment">-- lifetime of this memory, so it just leaks.</span><span>
</span><a name="line-315"></a><span class="hs-identifier">mkString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="GHCi.RemoteTypes.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-316"></a><a name="mkString"><a href="GHCi.Run.html#mkString"><span class="hs-identifier">mkString</span></a></a><span> </span><a name="local-6989586621679101601"><a href="#local-6989586621679101601"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Unsafe.html#unsafeUseAsCStringLen"><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unsafeUseAsCStringLen</span></a><span> </span><a href="#local-6989586621679101601"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679101602"><a href="#local-6989586621679101602"><span class="hs-identifier">cstr</span></a></a><span class="hs-special">,</span><a name="local-6989586621679101603"><a href="#local-6989586621679101603"><span class="hs-identifier">len</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-317"></a><span>  </span><a name="local-6989586621679101604"><a href="#local-6989586621679101604"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Marshal.Alloc.html#mallocBytes"><span class="hs-identifier hs-var">mallocBytes</span></a><span> </span><a href="#local-6989586621679101603"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-318"></a><span>  </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Marshal.Utils.html#copyBytes"><span class="hs-identifier hs-var">copyBytes</span></a><span> </span><a href="#local-6989586621679101604"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621679101602"><span class="hs-identifier hs-var">cstr</span></a><span> </span><a href="#local-6989586621679101603"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-319"></a><span>  </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHCi.RemoteTypes.html#castRemotePtr"><span class="hs-identifier hs-var">castRemotePtr</span></a><span> </span><span class="hs-special">(</span><a href="GHCi.RemoteTypes.html#toRemotePtr"><span class="hs-identifier hs-var">toRemotePtr</span></a><span> </span><a href="#local-6989586621679101604"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span class="hs-identifier">mkString0</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="GHCi.RemoteTypes.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-322"></a><a name="mkString0"><a href="GHCi.Run.html#mkString0"><span class="hs-identifier">mkString0</span></a></a><span> </span><a name="local-6989586621679101652"><a href="#local-6989586621679101652"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Unsafe.html#unsafeUseAsCStringLen"><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unsafeUseAsCStringLen</span></a><span> </span><a href="#local-6989586621679101652"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679101653"><a href="#local-6989586621679101653"><span class="hs-identifier">cstr</span></a></a><span class="hs-special">,</span><a name="local-6989586621679101654"><a href="#local-6989586621679101654"><span class="hs-identifier">len</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-323"></a><span>  </span><a name="local-6989586621679101655"><a href="#local-6989586621679101655"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Marshal.Alloc.html#mallocBytes"><span class="hs-identifier hs-var">mallocBytes</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679101654"><span class="hs-identifier hs-var">len</span></a><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-324"></a><span>  </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Marshal.Utils.html#copyBytes"><span class="hs-identifier hs-var">copyBytes</span></a><span> </span><a href="#local-6989586621679101655"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621679101653"><span class="hs-identifier hs-var">cstr</span></a><span> </span><a href="#local-6989586621679101654"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-325"></a><span>  </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Storable.html#pokeElemOff"><span class="hs-identifier hs-var">pokeElemOff</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679101655"><span class="hs-identifier hs-var">ptr</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.C.Types.html#CChar"><span class="hs-identifier hs-type">CChar</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679101654"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-326"></a><span>  </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHCi.RemoteTypes.html#castRemotePtr"><span class="hs-identifier hs-var">castRemotePtr</span></a><span> </span><span class="hs-special">(</span><a href="GHCi.RemoteTypes.html#toRemotePtr"><span class="hs-identifier hs-var">toRemotePtr</span></a><span> </span><a href="#local-6989586621679101655"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span class="hs-identifier">mkCostCentres</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">,</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><a href="GHCi.RemoteTypes.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Stack.CCS.html#CostCentre"><span class="hs-identifier hs-type">CostCentre</span></a><span class="hs-special">]</span><span>
</span><a name="line-329"></a><span class="hs-cpp">#if defined(PROFILING)</span><span>
</span><a name="line-330"></a><span class="hs-identifier">mkCostCentres</span><span> </span><span class="hs-identifier">mod</span><span> </span><span class="hs-identifier">ccs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-331"></a><span>  </span><span class="hs-identifier">c_module</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">newCString</span><span> </span><span class="hs-identifier">mod</span><span>
</span><a name="line-332"></a><span>  </span><span class="hs-identifier">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mk_one</span><span> </span><span class="hs-identifier">c_module</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ccs</span><span>
</span><a name="line-333"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-334"></a><span>  </span><span class="hs-identifier">mk_one</span><span> </span><span class="hs-identifier">c_module</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">decl_path</span><span class="hs-special">,</span><span class="hs-identifier">srcspan</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-335"></a><span>    </span><span class="hs-identifier">c_name</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">newCString</span><span> </span><span class="hs-identifier">decl_path</span><span>
</span><a name="line-336"></a><span>    </span><span class="hs-identifier">c_srcspan</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">newCString</span><span> </span><span class="hs-identifier">srcspan</span><span>
</span><a name="line-337"></a><span>    </span><span class="hs-identifier">toRemotePtr</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">c_mkCostCentre</span><span> </span><span class="hs-identifier">c_name</span><span> </span><span class="hs-identifier">c_module</span><span> </span><span class="hs-identifier">c_srcspan</span><span>
</span><a name="line-338"></a><span>
</span><a name="line-339"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;mkCostCentre&quot;</span><span>
</span><a name="line-340"></a><span>  </span><span class="hs-identifier">c_mkCostCentre</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CChar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CChar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CChar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CostCentre</span><span class="hs-special">)</span><span>
</span><a name="line-341"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-342"></a><a name="mkCostCentres"><a href="GHCi.Run.html#mkCostCentres"><span class="hs-identifier">mkCostCentres</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-343"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-344"></a><span>
</span><a name="line-345"></a><span class="hs-identifier">getIdValFromApStack</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHCi.RemoteTypes.html#HValue"><span class="hs-identifier hs-type">HValue</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="GHCi.RemoteTypes.html#HValue"><span class="hs-identifier hs-type">HValue</span></a><span class="hs-special">)</span><span>
</span><a name="line-346"></a><a name="getIdValFromApStack"><a href="GHCi.Run.html#getIdValFromApStack"><span class="hs-identifier">getIdValFromApStack</span></a></a><span> </span><a name="local-6989586621679101656"><a href="#local-6989586621679101656"><span class="hs-identifier">apStack</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I</span><span class="hs-operator hs-var">#</span><span> </span><a name="local-6989586621679101657"><a href="#local-6989586621679101657"><span class="hs-identifier">stackDepth</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-347"></a><span>   </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">getApStackVal</span><span class="hs-operator hs-var">#</span><span> </span><a href="#local-6989586621679101656"><span class="hs-identifier hs-var">apStack</span></a><span> </span><a href="#local-6989586621679101657"><span class="hs-identifier hs-var">stackDepth</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-348"></a><span>        </span><span class="hs-special">(</span><span class="hs-operator">#</span><span> </span><a name="local-6989586621679101658"><a href="#local-6989586621679101658"><span class="hs-identifier">ok</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679101659"><a href="#local-6989586621679101659"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-operator">#</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-349"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679101658"><span class="hs-identifier hs-var">ok</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-350"></a><span>              </span><span class="hs-number">0</span><span class="hs-operator">#</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-comment">-- AP_STACK not found</span><span>
</span><a name="line-351"></a><span>              </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeCoerce</span><span class="hs-operator hs-var">#</span><span> </span><a href="#local-6989586621679101659"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-352"></a></pre></body></html>