<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- Main entry point to the vectoriser.  It is invoked iff the option '-fvectorise' is passed.</span><span>
</span><a name="line-2"></a><span class="hs-comment">--</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- This module provides the function 'vectorise', which vectorises an entire (desugared) module.</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- It vectorises all type declarations and value bindings.  It also processes all VECTORISE pragmas</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- (aka vectorisation declarations), which can lead to the vectorisation of imported data types</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- and the enrichment of imported functions with vectorised versions.</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Vectorise</span><span> </span><span class="hs-special">(</span><span> </span><a href="Vectorise.html#vectorise"><span class="hs-identifier hs-var">vectorise</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-9"></a><span class="hs-keyword">where</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Type.Env.html"><span class="hs-identifier">Vectorise</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Env</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Type.Type.html"><span class="hs-identifier">Vectorise</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Convert.html"><span class="hs-identifier">Vectorise</span><span class="hs-operator">.</span><span class="hs-identifier">Convert</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Utils.Hoisting.html"><span class="hs-identifier">Vectorise</span><span class="hs-operator">.</span><span class="hs-identifier">Utils</span><span class="hs-operator">.</span><span class="hs-identifier">Hoisting</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Exp.html"><span class="hs-identifier">Vectorise</span><span class="hs-operator">.</span><span class="hs-identifier">Exp</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Env.html"><span class="hs-identifier">Vectorise</span><span class="hs-operator">.</span><span class="hs-identifier">Env</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Monad.html"><span class="hs-identifier">Vectorise</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span></a><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="HscTypes.html"><span class="hs-identifier">HscTypes</span></a><span> </span><span class="hs-keyword">hiding</span><span>      </span><span class="hs-special">(</span><span> </span><a href="HscTypes.html#MonadThings"><span class="hs-identifier hs-type">MonadThings</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="CoreUnfold.html"><span class="hs-identifier">CoreUnfold</span></a><span>           </span><span class="hs-special">(</span><span> </span><a href="CoreUnfold.html#mkInlineUnfoldingWithArity"><span class="hs-identifier hs-var">mkInlineUnfoldingWithArity</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="PprCore.html"><span class="hs-identifier">PprCore</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSyn.html"><span class="hs-identifier">CoreSyn</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="CoreMonad.html"><span class="hs-identifier">CoreMonad</span></a><span>            </span><span class="hs-special">(</span><span> </span><a href="CoreMonad.html#CoreM"><span class="hs-identifier hs-type">CoreM</span></a><span class="hs-special">,</span><span> </span><a href="CoreMonad.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="Id.html"><span class="hs-identifier">Id</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>                 </span><span class="hs-special">(</span><span> </span><a href="Util.html#zipLazy"><span class="hs-identifier hs-var">zipLazy</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="MonadUtils.html"><span class="hs-identifier">MonadUtils</span></a><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span></a><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-comment">-- |Vectorise a single module.</span><span>
</span><a name="line-37"></a><span class="hs-comment">--</span><span>
</span><a name="line-38"></a><span class="hs-identifier">vectorise</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HscTypes.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreMonad.html#CoreM"><span class="hs-identifier hs-type">CoreM</span></a><span> </span><a href="HscTypes.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a><span>
</span><a name="line-39"></a><a name="vectorise"><a href="Vectorise.html#vectorise"><span class="hs-identifier">vectorise</span></a></a><span> </span><a name="local-6989586621680353926"><a href="#local-6989586621680353926"><span class="hs-identifier">guts</span></a></a><span>
</span><a name="line-40"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680353927"><a href="#local-6989586621680353927"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreMonad.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-41"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Vectorise.html#vectoriseIO"><span class="hs-identifier hs-var">vectoriseIO</span></a><span> </span><a href="#local-6989586621680353927"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621680353926"><span class="hs-identifier hs-var">guts</span></a><span>
</span><a name="line-42"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span class="hs-comment">-- Vectorise a single monad, given the dynamic compiler flags and HscEnv.</span><span>
</span><a name="line-45"></a><span class="hs-comment">--</span><span>
</span><a name="line-46"></a><span class="hs-identifier">vectoriseIO</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HscTypes.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HscTypes.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="HscTypes.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a><span>
</span><a name="line-47"></a><a name="vectoriseIO"><a href="Vectorise.html#vectoriseIO"><span class="hs-identifier">vectoriseIO</span></a></a><span> </span><a name="local-6989586621680353928"><a href="#local-6989586621680353928"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621680353929"><a href="#local-6989586621680353929"><span class="hs-identifier">guts</span></a></a><span>
</span><a name="line-48"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>   </span><span class="hs-comment">-- Get information about currently loaded external packages.</span><span>
</span><a name="line-49"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680353930"><a href="#local-6989586621680353930"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscTypes.html#hscEPS"><span class="hs-identifier hs-var">hscEPS</span></a><span> </span><a href="#local-6989586621680353928"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span>          </span><span class="hs-comment">-- Combine vectorisation info from the current module, and external ones.</span><span>
</span><a name="line-52"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680353931"><a href="#local-6989586621680353931"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HscTypes.html#hptVectInfo"><span class="hs-identifier hs-var">hptVectInfo</span></a><span> </span><a href="#local-6989586621680353928"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">`</span><a href="HscTypes.html#plusVectInfo"><span class="hs-identifier hs-var">plusVectInfo</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">eps_vect_info</span><span> </span><a href="#local-6989586621680353930"><span class="hs-identifier hs-var">eps</span></a><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span>          </span><span class="hs-comment">-- Run the main VM computation.</span><span>
</span><a name="line-55"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680353932"><a href="#local-6989586621680353932"><span class="hs-identifier">info'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680353933"><a href="#local-6989586621680353933"><span class="hs-identifier">guts'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Monad.html#initV"><span class="hs-identifier hs-var">initV</span></a><span> </span><a href="#local-6989586621680353928"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621680353929"><span class="hs-identifier hs-var">guts</span></a><span> </span><a href="#local-6989586621680353931"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">(</span><a href="Vectorise.html#vectModule"><span class="hs-identifier hs-var">vectModule</span></a><span> </span><a href="#local-6989586621680353929"><span class="hs-identifier hs-var">guts</span></a><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680353933"><span class="hs-identifier hs-var">guts'</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_vect_info</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680353932"><span class="hs-identifier hs-var">info'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span class="hs-comment">-- Vectorise a single module, in the VM monad.</span><span>
</span><a name="line-60"></a><span class="hs-comment">--</span><span>
</span><a name="line-61"></a><span class="hs-identifier">vectModule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HscTypes.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Vectorise.Monad.Base.html#VM"><span class="hs-identifier hs-type">VM</span></a><span> </span><a href="HscTypes.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a><span>
</span><a name="line-62"></a><a name="vectModule"><a href="Vectorise.html#vectModule"><span class="hs-identifier">vectModule</span></a></a><span> </span><a name="local-6989586621680353934"><a href="#local-6989586621680353934"><span class="hs-identifier">guts</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="HscTypes.html#ModGuts"><span class="hs-identifier hs-var">ModGuts</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_tcs</span><span>        </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680353935"><a href="#local-6989586621680353935"><span class="hs-identifier">tycons</span></a></a><span>
</span><a name="line-63"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_binds</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680353936"><a href="#local-6989586621680353936"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-64"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_fam_insts</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680353937"><a href="#local-6989586621680353937"><span class="hs-identifier">fam_insts</span></a></a><span>
</span><a name="line-65"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_vect_decls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680353938"><a href="#local-6989586621680353938"><span class="hs-identifier">vect_decls</span></a></a><span>
</span><a name="line-66"></a><span>                         </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="Vectorise.Monad.Base.html#dumpOptVt"><span class="hs-identifier hs-var">dumpOptVt</span></a><span> </span><a href="DynFlags.html#Opt_D_dump_vt_trace"><span class="hs-identifier hs-var">Opt_D_dump_vt_trace</span></a><span> </span><span class="hs-string">&quot;Before vectorisation&quot;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-68"></a><span>          </span><a href="PprCore.html#pprCoreBindings"><span class="hs-identifier hs-var">pprCoreBindings</span></a><span> </span><a href="#local-6989586621680353936"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span>          </span><span class="hs-comment">-- Pick out all 'VECTORISE [SCALAR] type' and 'VECTORISE class' pragmas</span><span>
</span><a name="line-71"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680353939"><a href="#local-6989586621680353939"><span class="hs-identifier">ty_vect_decls</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680353941"><span class="hs-identifier hs-var">vd</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621680353941"><a href="#local-6989586621680353941"><span class="hs-identifier">vd</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#VectType"><span class="hs-identifier hs-var">VectType</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680353938"><span class="hs-identifier hs-var">vect_decls</span></a><span class="hs-special">]</span><span>
</span><a name="line-72"></a><span>            </span><a name="local-6989586621680353940"><a href="#local-6989586621680353940"><span class="hs-identifier">cls_vect_decls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680353942"><span class="hs-identifier hs-var">vd</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621680353942"><a href="#local-6989586621680353942"><span class="hs-identifier">vd</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#VectClass"><span class="hs-identifier hs-var">VectClass</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680353938"><span class="hs-identifier hs-var">vect_decls</span></a><span class="hs-special">]</span><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span>          </span><span class="hs-comment">-- Vectorise the type environment.  This will add vectorised</span><span>
</span><a name="line-75"></a><span>          </span><span class="hs-comment">-- type constructors, their representations, and the</span><span>
</span><a name="line-76"></a><span>          </span><span class="hs-comment">-- corresponding data constructors.  Moreover, we produce</span><span>
</span><a name="line-77"></a><span>          </span><span class="hs-comment">-- bindings for dfuns and family instances of the classes</span><span>
</span><a name="line-78"></a><span>          </span><span class="hs-comment">-- and type families used in the DPH library to represent</span><span>
</span><a name="line-79"></a><span>          </span><span class="hs-comment">-- array types.</span><span>
</span><a name="line-80"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680353943"><a href="#local-6989586621680353943"><span class="hs-identifier">new_tycons</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680353944"><a href="#local-6989586621680353944"><span class="hs-identifier">new_fam_insts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680353945"><a href="#local-6989586621680353945"><span class="hs-identifier">tc_binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Type.Env.html#vectTypeEnv"><span class="hs-identifier hs-var">vectTypeEnv</span></a><span> </span><a href="#local-6989586621680353935"><span class="hs-identifier hs-var">tycons</span></a><span> </span><a href="#local-6989586621680353939"><span class="hs-identifier hs-var">ty_vect_decls</span></a><span> </span><a href="#local-6989586621680353940"><span class="hs-identifier hs-var">cls_vect_decls</span></a><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span>          </span><span class="hs-comment">-- Family instance environment for /all/ home-package modules including those instances</span><span>
</span><a name="line-83"></a><span>          </span><span class="hs-comment">-- generated by 'vectTypeEnv'.</span><span>
</span><a name="line-84"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680353946"><a href="#local-6989586621680353946"><span class="hs-identifier">fam_inst_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Monad.Global.html#readGEnv"><span class="hs-identifier hs-var">readGEnv</span></a><span> </span><span class="hs-identifier">global_fam_inst_env</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span>          </span><span class="hs-comment">-- Vectorise all the top level bindings and VECTORISE declarations on imported identifiers</span><span>
</span><a name="line-87"></a><span>          </span><span class="hs-comment">-- NB: Need to vectorise the imported bindings first (local bindings may depend on them).</span><span>
</span><a name="line-88"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680353947"><a href="#local-6989586621680353947"><span class="hs-identifier">impBinds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621680353948"><span class="hs-identifier hs-var">imp_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680353949"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#Vect"><span class="hs-identifier hs-var">Vect</span></a><span> </span><a name="local-6989586621680353948"><a href="#local-6989586621680353948"><span class="hs-identifier">imp_id</span></a></a><span> </span><a name="local-6989586621680353949"><a href="#local-6989586621680353949"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680353938"><span class="hs-identifier hs-var">vect_decls</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#isGlobalId"><span class="hs-identifier hs-var">isGlobalId</span></a><span> </span><a href="#local-6989586621680353948"><span class="hs-identifier hs-var">imp_id</span></a><span class="hs-special">]</span><span>
</span><a name="line-89"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680353950"><a href="#local-6989586621680353950"><span class="hs-identifier">binds_imp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="Vectorise.html#vectImpBind"><span class="hs-identifier hs-var">vectImpBind</span></a><span> </span><a href="#local-6989586621680353947"><span class="hs-identifier hs-var">impBinds</span></a><span>
</span><a name="line-90"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680353951"><a href="#local-6989586621680353951"><span class="hs-identifier">binds_top</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="Vectorise.html#vectTopBind"><span class="hs-identifier hs-var">vectTopBind</span></a><span> </span><a href="#local-6989586621680353936"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-6989586621680353934"><span class="hs-identifier hs-var">guts</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_tcs</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680353935"><span class="hs-identifier hs-var">tycons</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680353943"><span class="hs-identifier hs-var">new_tycons</span></a><span>
</span><a name="line-93"></a><span>                        </span><span class="hs-comment">-- we produce no new classes or instances, only new class type constructors</span><span>
</span><a name="line-94"></a><span>                        </span><span class="hs-comment">-- and dfuns</span><span>
</span><a name="line-95"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_binds</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a href="#local-6989586621680353945"><span class="hs-identifier hs-var">tc_binds</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680353951"><span class="hs-identifier hs-var">binds_top</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680353950"><span class="hs-identifier hs-var">binds_imp</span></a><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_fam_inst_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680353946"><span class="hs-identifier hs-var">fam_inst_env</span></a><span>
</span><a name="line-97"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_fam_insts</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680353937"><span class="hs-identifier hs-var">fam_insts</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680353944"><span class="hs-identifier hs-var">new_fam_insts</span></a><span>
</span><a name="line-98"></a><span>                      </span><span class="hs-special">}</span><span>
</span><a name="line-99"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span class="hs-comment">-- Try to vectorise a top-level binding.  If it doesn't vectorise, or if it is entirely scalar, then</span><span>
</span><a name="line-102"></a><span class="hs-comment">-- omit vectorisation of that binding.</span><span>
</span><a name="line-103"></a><span class="hs-comment">--</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- For example, for the binding</span><span>
</span><a name="line-105"></a><span class="hs-comment">--</span><span>
</span><a name="line-106"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-107"></a><span class="hs-comment">--    foo :: Int -&gt; Int</span><span>
</span><a name="line-108"></a><span class="hs-comment">--    foo = \x -&gt; x + x</span><span>
</span><a name="line-109"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-110"></a><span class="hs-comment">--</span><span>
</span><a name="line-111"></a><span class="hs-comment">-- we get</span><span>
</span><a name="line-112"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-113"></a><span class="hs-comment">--    foo  :: Int -&gt; Int</span><span>
</span><a name="line-114"></a><span class="hs-comment">--    foo  = \x -&gt; vfoo $: x</span><span>
</span><a name="line-115"></a><span class="hs-comment">--</span><span>
</span><a name="line-116"></a><span class="hs-comment">--    v_foo :: Closure void vfoo lfoo</span><span>
</span><a name="line-117"></a><span class="hs-comment">--    v_foo = closure vfoo lfoo void</span><span>
</span><a name="line-118"></a><span class="hs-comment">--</span><span>
</span><a name="line-119"></a><span class="hs-comment">--    vfoo :: Void -&gt; Int -&gt; Int</span><span>
</span><a name="line-120"></a><span class="hs-comment">--    vfoo = ...</span><span>
</span><a name="line-121"></a><span class="hs-comment">--</span><span>
</span><a name="line-122"></a><span class="hs-comment">--    lfoo :: PData Void -&gt; PData Int -&gt; PData Int</span><span>
</span><a name="line-123"></a><span class="hs-comment">--    lfoo = ...</span><span>
</span><a name="line-124"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-125"></a><span class="hs-comment">--</span><span>
</span><a name="line-126"></a><span class="hs-comment">-- @vfoo@ is the &quot;vectorised&quot;, or scalar, version that does the same as the original function foo,</span><span>
</span><a name="line-127"></a><span class="hs-comment">-- but takes an explicit environment.</span><span>
</span><a name="line-128"></a><span class="hs-comment">--</span><span>
</span><a name="line-129"></a><span class="hs-comment">-- @lfoo@ is the &quot;lifted&quot; version that works on arrays.</span><span>
</span><a name="line-130"></a><span class="hs-comment">--</span><span>
</span><a name="line-131"></a><span class="hs-comment">-- @v_foo@ combines both of these into a `Closure` that also contains the environment.</span><span>
</span><a name="line-132"></a><span class="hs-comment">--</span><span>
</span><a name="line-133"></a><span class="hs-comment">-- The original binding @foo@ is rewritten to call the vectorised version present in the closure.</span><span>
</span><a name="line-134"></a><span class="hs-comment">--</span><span>
</span><a name="line-135"></a><span class="hs-comment">-- Vectorisation may be suppressed by annotating a binding with a 'NOVECTORISE' pragma.  If this</span><span>
</span><a name="line-136"></a><span class="hs-comment">-- pragma is used in a group of mutually recursive bindings, either all or no binding must have</span><span>
</span><a name="line-137"></a><span class="hs-comment">-- the pragma.  If only some bindings are annotated, a fatal error is being raised. (In the case of</span><span>
</span><a name="line-138"></a><span class="hs-comment">-- scalar bindings, we only omit vectorisation if all bindings in a group are scalar.)</span><span>
</span><a name="line-139"></a><span class="hs-comment">--</span><span>
</span><a name="line-140"></a><span class="hs-comment">-- FIXME: Once we support partial vectorisation, we may be able to vectorise parts of a group, or</span><span>
</span><a name="line-141"></a><span class="hs-comment">--   we may emit a warning and refrain from vectorising the entire group.</span><span>
</span><a name="line-142"></a><span class="hs-comment">--</span><span>
</span><a name="line-143"></a><span class="hs-identifier">vectTopBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Vectorise.Monad.Base.html#VM"><span class="hs-identifier hs-type">VM</span></a><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span>
</span><a name="line-144"></a><a name="vectTopBind"><a href="Vectorise.html#vectTopBind"><span class="hs-identifier">vectTopBind</span></a></a><span> </span><a name="local-6989586621680353952"><a href="#local-6989586621680353952"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-6989586621680353953"><a href="#local-6989586621680353953"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621680353954"><a href="#local-6989586621680353954"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-146"></a><span>    </span><span class="hs-special">{</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot;= Vectorise non-recursive top-level variable&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680353953"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>
</span><a name="line-148"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680353955"><a href="#local-6989586621680353955"><span class="hs-identifier">hasNoVect</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680353956"><a href="#local-6989586621680353956"><span class="hs-identifier">vectDecl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Monad.Global.html#lookupVectDecl"><span class="hs-identifier hs-var">lookupVectDecl</span></a><span> </span><a href="#local-6989586621680353953"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-149"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680353955"><span class="hs-identifier hs-var">hasNoVect</span></a><span>
</span><a name="line-150"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-151"></a><span>      </span><span class="hs-special">{</span><span>   </span><span class="hs-comment">-- 'NOVECTORISE' pragma =&gt; leave this binding as it is</span><span>
</span><a name="line-152"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot;NOVECTORISE&quot;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680353953"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-153"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680353952"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-154"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-155"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-156"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680353958"><a href="#local-6989586621680353958"><span class="hs-identifier">vectRhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680353956"><span class="hs-identifier hs-var">vectDecl</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-157"></a><span>        </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680353957"><a href="#local-6989586621680353957"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-158"></a><span>            </span><span class="hs-comment">-- 'VECTORISE' pragma =&gt; just use the provided vectorised rhs</span><span>
</span><a name="line-159"></a><span>          </span><span class="hs-keyword">do</span><span>
</span><a name="line-160"></a><span>          </span><span class="hs-special">{</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot;VECTORISE&quot;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680353953"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-161"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="Vectorise.Monad.html#addGlobalParallelVar"><span class="hs-identifier hs-var">addGlobalParallelVar</span></a><span> </span><a href="#local-6989586621680353953"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-162"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="Vectorise.Utils.Hoisting.html#inlineMe"><span class="hs-identifier hs-var">inlineMe</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680353957"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span>
</span><a name="line-163"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-164"></a><span>        </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>         </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-165"></a><span>            </span><span class="hs-comment">-- no pragma =&gt; standard vectorisation of rhs</span><span>
</span><a name="line-166"></a><span>          </span><span class="hs-keyword">do</span><span>
</span><a name="line-167"></a><span>          </span><span class="hs-special">{</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot;[Vanilla]&quot;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680353953"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'='</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680353954"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-168"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="Vectorise.Exp.html#vectTopExpr"><span class="hs-identifier hs-var">vectTopExpr</span></a><span> </span><a href="#local-6989586621680353953"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621680353954"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-169"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-170"></a><span>    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680353959"><a href="#local-6989586621680353959"><span class="hs-identifier">hs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Utils.Hoisting.html#takeHoisted"><span class="hs-identifier hs-var">takeHoisted</span></a><span> </span><span class="hs-comment">-- make sure we clean those out (even if we skip)</span><span>
</span><a name="line-171"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680353958"><span class="hs-identifier hs-var">vectRhs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-172"></a><span>      </span><span class="hs-special">{</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-173"></a><span>          </span><span class="hs-comment">-- scalar binding =&gt; leave this binding as it is</span><span>
</span><a name="line-174"></a><span>          </span><span class="hs-keyword">do</span><span>
</span><a name="line-175"></a><span>          </span><span class="hs-special">{</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot;scalar binding [skip]&quot;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680353953"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-176"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680353952"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-177"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-178"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680353960"><a href="#local-6989586621680353960"><span class="hs-identifier">parBind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680353961"><a href="#local-6989586621680353961"><span class="hs-identifier">inline</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680353962"><a href="#local-6989586621680353962"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-179"></a><span>    </span><span class="hs-special">{</span><span>
</span><a name="line-180"></a><span>       </span><span class="hs-comment">-- vanilla case =&gt; create an appropriate top-level binding &amp; add it to the vectorisation map</span><span>
</span><a name="line-181"></a><span>    </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><a href="#local-6989586621680353960"><span class="hs-identifier hs-var">parBind</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-182"></a><span>        </span><a href="Vectorise.Monad.html#addGlobalParallelVar"><span class="hs-identifier hs-var">addGlobalParallelVar</span></a><span> </span><a href="#local-6989586621680353953"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-183"></a><span>    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680353963"><a href="#local-6989586621680353963"><span class="hs-identifier">var'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.html#vectTopBinder"><span class="hs-identifier hs-var">vectTopBinder</span></a><span> </span><a href="#local-6989586621680353953"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621680353961"><span class="hs-identifier hs-var">inline</span></a><span> </span><a href="#local-6989586621680353962"><span class="hs-identifier hs-var">expr'</span></a><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span>        </span><span class="hs-comment">-- We replace the original top-level binding by a value projected from the vectorised</span><span>
</span><a name="line-186"></a><span>        </span><span class="hs-comment">-- closure and add any newly created hoisted top-level bindings.</span><span>
</span><a name="line-187"></a><span>    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680353964"><a href="#local-6989586621680353964"><span class="hs-identifier">cexpr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.html#tryConvert"><span class="hs-identifier hs-var">tryConvert</span></a><span> </span><a href="#local-6989586621680353953"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621680353963"><span class="hs-identifier hs-var">var'</span></a><span> </span><a href="#local-6989586621680353954"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-188"></a><span>    </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680353953"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680353964"><span class="hs-identifier hs-var">cexpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680353963"><span class="hs-identifier hs-var">var'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680353962"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680353959"><span class="hs-identifier hs-var">hs</span></a><span>
</span><a name="line-189"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-190"></a><span>    </span><span class="hs-special">`</span><a href="Vectorise.Monad.Base.html#orElseErrV"><span class="hs-identifier hs-var">orElseErrV</span></a><span class="hs-special">`</span><span>
</span><a name="line-191"></a><span>    </span><span class="hs-keyword">do</span><span>
</span><a name="line-192"></a><span>    </span><span class="hs-special">{</span><span> </span><a href="Vectorise.Monad.Base.html#emitVt"><span class="hs-identifier hs-var">emitVt</span></a><span> </span><span class="hs-string">&quot;  Could NOT vectorise top-level binding&quot;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680353953"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-193"></a><span>    </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680353952"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-194"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-195"></a><span class="hs-identifier">vectTopBind</span><span> </span><a name="local-6989586621680353965"><a href="#local-6989586621680353965"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-6989586621680353966"><a href="#local-6989586621680353966"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-197"></a><span>    </span><span class="hs-special">{</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot;= Vectorise recursive top-level variables&quot;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680353967"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span>    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680353976"><a href="#local-6989586621680353976"><span class="hs-identifier">vectDecls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="Vectorise.Monad.Global.html#lookupVectDecl"><span class="hs-identifier hs-var">lookupVectDecl</span></a><span> </span><a href="#local-6989586621680353967"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-200"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680353977"><a href="#local-6989586621680353977"><span class="hs-identifier">hasNoVects</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span> </span><a href="#local-6989586621680353976"><span class="hs-identifier hs-var">vectDecls</span></a><span>
</span><a name="line-201"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#and"><span class="hs-identifier hs-var">and</span></a><span> </span><a href="#local-6989586621680353977"><span class="hs-identifier hs-var">hasNoVects</span></a><span>
</span><a name="line-202"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-203"></a><span>      </span><span class="hs-special">{</span><span>   </span><span class="hs-comment">-- 'NOVECTORISE' pragmas =&gt; leave this entire binding group as it is</span><span>
</span><a name="line-204"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot;NOVECTORISE&quot;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680353967"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-205"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680353965"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-206"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-207"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-208"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#or"><span class="hs-identifier hs-var">or</span></a><span> </span><a href="#local-6989586621680353977"><span class="hs-identifier hs-var">hasNoVects</span></a><span>
</span><a name="line-209"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-210"></a><span>        </span><span class="hs-special">{</span><span>   </span><span class="hs-comment">-- Inconsistent 'NOVECTORISE' pragmas =&gt; bail out</span><span>
</span><a name="line-211"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680353978"><a href="#local-6989586621680353978"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-212"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Vectorise.Monad.Base.html#cantVectorise"><span class="hs-identifier hs-var">cantVectorise</span></a><span> </span><a href="#local-6989586621680353978"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680353968"><span class="hs-identifier hs-var">noVectoriseErr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680353965"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-214"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-215"></a><span>    </span><span class="hs-special">{</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot;[Vanilla]&quot;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680353979"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'='</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680353980"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680353979"><a href="#local-6989586621680353979"><span class="hs-identifier">var</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680353980"><a href="#local-6989586621680353980"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680353966"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">]</span><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span>       </span><span class="hs-comment">-- For all bindings *with* a pragma, just use the pragma-supplied vectorised expression</span><span>
</span><a name="line-218"></a><span>    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680353983"><a href="#local-6989586621680353983"><span class="hs-identifier">newBindsWPragma</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span>
</span><a name="line-219"></a><span>                          </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#sequence"><span class="hs-identifier hs-var">sequence</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621680353969"><span class="hs-identifier hs-var">vectTopBindAndConvert</span></a><span> </span><a href="#local-6989586621680353981"><span class="hs-identifier hs-var">bind</span></a><span> </span><a href="Vectorise.Utils.Hoisting.html#inlineMe"><span class="hs-identifier hs-var">inlineMe</span></a><span> </span><a href="#local-6989586621680353982"><span class="hs-identifier hs-var">expr'</span></a><span>
</span><a name="line-220"></a><span>                                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680353981"><a href="#local-6989586621680353981"><span class="hs-identifier">bind</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680353982"><a href="#local-6989586621680353982"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span> </span><a href="#local-6989586621680353966"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621680353976"><span class="hs-identifier hs-var">vectDecls</span></a><span class="hs-special">]</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span>        </span><span class="hs-comment">-- Standard vectorisation of all rhses that are *without* a pragma.</span><span>
</span><a name="line-223"></a><span>        </span><span class="hs-comment">-- NB: The reason for 'fixV' is rather subtle: 'vectTopBindAndConvert' adds entries for</span><span>
</span><a name="line-224"></a><span>        </span><span class="hs-comment">--     the bound variables in the recursive group to the vectorisation map, which in turn</span><span>
</span><a name="line-225"></a><span>        </span><span class="hs-comment">--     are needed by 'vectPolyExprs' (unless it returns 'Nothing').</span><span>
</span><a name="line-226"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680353984"><a href="#local-6989586621680353984"><span class="hs-identifier">bindsWOPragma</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680353985"><span class="hs-identifier hs-var">bind</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680353985"><a href="#local-6989586621680353985"><span class="hs-identifier">bind</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span> </span><a href="#local-6989586621680353966"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621680353976"><span class="hs-identifier hs-var">vectDecls</span></a><span class="hs-special">]</span><span>
</span><a name="line-227"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680353995"><a href="#local-6989586621680353995"><span class="hs-identifier">newBinds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Monad.Base.html#fixV"><span class="hs-identifier hs-var">fixV</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-228"></a><span>        </span><span class="hs-glyph">\</span><span> </span><span class="hs-glyph">~</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680353986"><a href="#local-6989586621680353986"><span class="hs-identifier">exprs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-229"></a><span>          </span><span class="hs-keyword">do</span><span>
</span><a name="line-230"></a><span>          </span><span class="hs-special">{</span><span>   </span><span class="hs-comment">-- Create appropriate top-level bindings, enter them into the vectorisation map, and</span><span>
</span><a name="line-231"></a><span>              </span><span class="hs-comment">-- vectorise the right-hand sides</span><span>
</span><a name="line-232"></a><span>          </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680353990"><a href="#local-6989586621680353990"><span class="hs-identifier">newBindsWOPragma</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span>
</span><a name="line-233"></a><span>                                </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#sequence"><span class="hs-identifier hs-var">sequence</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680353969"><span class="hs-identifier hs-var">vectTopBindAndConvert</span></a><span> </span><a href="#local-6989586621680353987"><span class="hs-identifier hs-var">bind</span></a><span> </span><a href="#local-6989586621680353988"><span class="hs-identifier hs-var">inline</span></a><span> </span><a href="#local-6989586621680353989"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-234"></a><span>                                         </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680353987"><a href="#local-6989586621680353987"><span class="hs-identifier">bind</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">~</span><span class="hs-special">(</span><a name="local-6989586621680353988"><a href="#local-6989586621680353988"><span class="hs-identifier">inline</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680353989"><a href="#local-6989586621680353989"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Util.html#zipLazy"><span class="hs-identifier hs-var">zipLazy</span></a><span> </span><a href="#local-6989586621680353984"><span class="hs-identifier hs-var">bindsWOPragma</span></a><span> </span><a href="#local-6989586621680353986"><span class="hs-identifier hs-var">exprs'</span></a><span class="hs-special">]</span><span>
</span><a name="line-235"></a><span>                                         </span><span class="hs-comment">-- irrefutable pattern and 'zipLazy' to tie the knot;</span><span>
</span><a name="line-236"></a><span>                                         </span><span class="hs-comment">-- hence, can't use 'zipWithM'</span><span>
</span><a name="line-237"></a><span>          </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680353991"><a href="#local-6989586621680353991"><span class="hs-identifier">vectRhses</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Exp.html#vectTopExprs"><span class="hs-identifier hs-var">vectTopExprs</span></a><span> </span><a href="#local-6989586621680353984"><span class="hs-identifier hs-var">bindsWOPragma</span></a><span>
</span><a name="line-238"></a><span>          </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680353992"><a href="#local-6989586621680353992"><span class="hs-identifier">hs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Utils.Hoisting.html#takeHoisted"><span class="hs-identifier hs-var">takeHoisted</span></a><span> </span><span class="hs-comment">-- make sure we clean those out (even if we skip)</span><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680353991"><span class="hs-identifier hs-var">vectRhses</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-241"></a><span>              </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-242"></a><span>                </span><span class="hs-comment">-- scalar bindings =&gt; skip all bindings except those with pragmas and retract the</span><span>
</span><a name="line-243"></a><span>                </span><span class="hs-comment">--   entries into the vectorisation map for the scalar bindings</span><span>
</span><a name="line-244"></a><span>                </span><span class="hs-keyword">do</span><span>
</span><a name="line-245"></a><span>                </span><span class="hs-special">{</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot;scalar bindings [skip]&quot;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680353967"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-246"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="Vectorise.Monad.Global.html#undefGlobalVar"><span class="hs-identifier hs-var">undefGlobalVar</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680353984"><span class="hs-identifier hs-var">bindsWOPragma</span></a><span>
</span><a name="line-247"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680353984"><span class="hs-identifier hs-var">bindsWOPragma</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680353983"><span class="hs-identifier hs-var">newBindsWPragma</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680353986"><span class="hs-identifier hs-var">exprs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-248"></a><span>                </span><span class="hs-special">}</span><span>
</span><a name="line-249"></a><span>              </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680353993"><a href="#local-6989586621680353993"><span class="hs-identifier">parBind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680353994"><a href="#local-6989586621680353994"><span class="hs-identifier">exprs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-250"></a><span>                </span><span class="hs-comment">-- vanilla case =&gt; record parallel variables and return the final bindings</span><span>
</span><a name="line-251"></a><span>                </span><span class="hs-keyword">do</span><span>
</span><a name="line-252"></a><span>                </span><span class="hs-special">{</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><a href="#local-6989586621680353993"><span class="hs-identifier hs-var">parBind</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-253"></a><span>                    </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="Vectorise.Monad.html#addGlobalParallelVar"><span class="hs-identifier hs-var">addGlobalParallelVar</span></a><span> </span><a href="#local-6989586621680353967"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-254"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680353990"><span class="hs-identifier hs-var">newBindsWOPragma</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680353983"><span class="hs-identifier hs-var">newBindsWPragma</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680353992"><span class="hs-identifier hs-var">hs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680353994"><span class="hs-identifier hs-var">exprs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-255"></a><span>                </span><span class="hs-special">}</span><span>
</span><a name="line-256"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-257"></a><span>    </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a href="#local-6989586621680353995"><span class="hs-identifier hs-var">newBinds</span></a><span>
</span><a name="line-258"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-259"></a><span>    </span><span class="hs-special">`</span><a href="Vectorise.Monad.Base.html#orElseErrV"><span class="hs-identifier hs-var">orElseErrV</span></a><span class="hs-special">`</span><span>
</span><a name="line-260"></a><span>    </span><span class="hs-keyword">do</span><span>
</span><a name="line-261"></a><span>    </span><span class="hs-special">{</span><span> </span><a href="Vectorise.Monad.Base.html#emitVt"><span class="hs-identifier hs-var">emitVt</span></a><span> </span><span class="hs-string">&quot;  Could NOT vectorise top-level bindings&quot;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680353967"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-262"></a><span>    </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680353965"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-263"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-264"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-265"></a><span>    </span><a name="local-6989586621680353967"><a href="#local-6989586621680353967"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span> </span><a href="#local-6989586621680353966"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-266"></a><span>    </span><a name="local-6989586621680353968"><a href="#local-6989586621680353968"><span class="hs-identifier">noVectoriseErr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;NOVECTORISE must be used on all or no bindings of a recursive group&quot;</span><span>
</span><a name="line-267"></a><span>
</span><a name="line-268"></a><span>    </span><span class="hs-comment">-- Replace the original top-level bindings by a values projected from the vectorised</span><span>
</span><a name="line-269"></a><span>    </span><span class="hs-comment">-- closures and add any newly created hoisted top-level bindings to the group.</span><span>
</span><a name="line-270"></a><span>    </span><a name="local-6989586621680353969"><a href="#local-6989586621680353969"><span class="hs-identifier">vectTopBindAndConvert</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680353970"><a href="#local-6989586621680353970"><span class="hs-identifier">var</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680353971"><a href="#local-6989586621680353971"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680353972"><a href="#local-6989586621680353972"><span class="hs-identifier">inline</span></a></a><span> </span><a name="local-6989586621680353973"><a href="#local-6989586621680353973"><span class="hs-identifier">expr'</span></a></a><span>
</span><a name="line-271"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-272"></a><span>        </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680353974"><a href="#local-6989586621680353974"><span class="hs-identifier">var'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.html#vectTopBinder"><span class="hs-identifier hs-var">vectTopBinder</span></a><span> </span><a href="#local-6989586621680353970"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621680353972"><span class="hs-identifier hs-var">inline</span></a><span> </span><a href="#local-6989586621680353973"><span class="hs-identifier hs-var">expr'</span></a><span>
</span><a name="line-273"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680353975"><a href="#local-6989586621680353975"><span class="hs-identifier">cexpr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.html#tryConvert"><span class="hs-identifier hs-var">tryConvert</span></a><span> </span><a href="#local-6989586621680353970"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621680353974"><span class="hs-identifier hs-var">var'</span></a><span> </span><a href="#local-6989586621680353971"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-274"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621680353970"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680353975"><span class="hs-identifier hs-var">cexpr</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680353974"><span class="hs-identifier hs-var">var'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680353973"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-275"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span class="hs-comment">-- Add a vectorised binding to an imported top-level variable that has a VECTORISE pragma</span><span>
</span><a name="line-278"></a><span class="hs-comment">-- in this module.</span><span>
</span><a name="line-279"></a><span class="hs-comment">--</span><span>
</span><a name="line-280"></a><span class="hs-comment">-- RESTRICTION: Currently, we cannot use the pragma for mutually recursive definitions.</span><span>
</span><a name="line-281"></a><span class="hs-comment">--</span><span>
</span><a name="line-282"></a><span class="hs-identifier">vectImpBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Vectorise.Monad.Base.html#VM"><span class="hs-identifier hs-type">VM</span></a><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span>
</span><a name="line-283"></a><a name="vectImpBind"><a href="Vectorise.html#vectImpBind"><span class="hs-identifier">vectImpBind</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680353996"><a href="#local-6989586621680353996"><span class="hs-identifier">var</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680353997"><a href="#local-6989586621680353997"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-284"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-285"></a><span>    </span><span class="hs-special">{</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot;= Add vectorised binding to imported variable&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680353996"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span>    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680353998"><a href="#local-6989586621680353998"><span class="hs-identifier">var'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.html#vectTopBinder"><span class="hs-identifier hs-var">vectTopBinder</span></a><span> </span><a href="#local-6989586621680353996"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="Vectorise.Utils.Hoisting.html#inlineMe"><span class="hs-identifier hs-var">inlineMe</span></a><span> </span><a href="#local-6989586621680353997"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-288"></a><span>    </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-6989586621680353998"><span class="hs-identifier hs-var">var'</span></a><span> </span><a href="#local-6989586621680353997"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-289"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-290"></a><span>
</span><a name="line-291"></a><span class="hs-comment">-- |Make the vectorised version of this top level binder, and add the mapping between it and the</span><span>
</span><a name="line-292"></a><span class="hs-comment">-- original to the state. For some binder @foo@ the vectorised version is @$v_foo@</span><span>
</span><a name="line-293"></a><span class="hs-comment">--</span><span>
</span><a name="line-294"></a><span class="hs-comment">-- NOTE: 'vectTopBinder' *MUST* be lazy in inline and expr because of how it is used inside of</span><span>
</span><a name="line-295"></a><span class="hs-comment">--       'fixV' in 'vectTopBind'.</span><span>
</span><a name="line-296"></a><span class="hs-comment">--</span><span>
</span><a name="line-297"></a><span class="hs-identifier">vectTopBinder</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span>      </span><span class="hs-comment">-- ^ Name of the binding.</span><span>
</span><a name="line-298"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Vectorise.Utils.Hoisting.html#Inline"><span class="hs-identifier hs-type">Inline</span></a><span>   </span><span class="hs-comment">-- ^ Whether it should be inlined, used to annotate it.</span><span>
</span><a name="line-299"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-comment">-- ^ RHS of binding, used to set the 'Unfolding' of the returned 'Var'.</span><span>
</span><a name="line-300"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Vectorise.Monad.Base.html#VM"><span class="hs-identifier hs-type">VM</span></a><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span>   </span><span class="hs-comment">-- ^ Name of the vectorised binding.</span><span>
</span><a name="line-301"></a><a name="vectTopBinder"><a href="Vectorise.html#vectTopBinder"><span class="hs-identifier">vectTopBinder</span></a></a><span> </span><a name="local-6989586621680353999"><a href="#local-6989586621680353999"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621680354000"><a href="#local-6989586621680354000"><span class="hs-identifier">inline</span></a></a><span> </span><a name="local-6989586621680354001"><a href="#local-6989586621680354001"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-302"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>   </span><span class="hs-comment">-- Vectorise the type attached to the var.</span><span>
</span><a name="line-303"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680354004"><a href="#local-6989586621680354004"><span class="hs-identifier">vty</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Type.Type.html#vectType"><span class="hs-identifier hs-var">vectType</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-6989586621680353999"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span>          </span><span class="hs-comment">-- If there is a vectorisation declaration for this binding, make sure its type matches</span><span>
</span><a name="line-306"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680354005"><a href="#local-6989586621680354005"><span class="hs-identifier">vectDecl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Monad.Global.html#lookupVectDecl"><span class="hs-identifier hs-var">lookupVectDecl</span></a><span> </span><a href="#local-6989586621680353999"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-307"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680354005"><span class="hs-identifier hs-var">vectDecl</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-308"></a><span>          </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-309"></a><span>          </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680354006"><a href="#local-6989586621680354006"><span class="hs-identifier">vdty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-310"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span> </span><a href="#local-6989586621680354004"><span class="hs-identifier hs-var">vty</span></a><span> </span><a href="#local-6989586621680354006"><span class="hs-identifier hs-var">vdty</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>       </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-312"></a><span>              </span><span class="hs-keyword">do</span><span>
</span><a name="line-313"></a><span>              </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680354007"><a href="#local-6989586621680354007"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-314"></a><span>              </span><span class="hs-special">;</span><span> </span><a href="Vectorise.Monad.Base.html#cantVectorise"><span class="hs-identifier hs-var">cantVectorise</span></a><span> </span><a href="#local-6989586621680354007"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Type mismatch in vectorisation pragma for &quot;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="Outputable.html#showPpr"><span class="hs-identifier hs-var">showPpr</span></a><span> </span><a href="#local-6989586621680354007"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680353999"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-315"></a><span>                  </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Expected type&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680354004"><span class="hs-identifier hs-var">vty</span></a><span class="hs-special">)</span><span>
</span><a name="line-316"></a><span>                  </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-317"></a><span>                  </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Inferred type&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680354006"><span class="hs-identifier hs-var">vdty</span></a><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>              </span><span class="hs-special">}</span><span>
</span><a name="line-319"></a><span>          </span><span class="hs-comment">-- Make the vectorised version of binding's name, and set the unfolding used for inlining</span><span>
</span><a name="line-320"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680354008"><a href="#local-6989586621680354008"><span class="hs-identifier">var'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#liftM"><span class="hs-identifier hs-var">liftM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Id.html#setIdUnfolding"><span class="hs-identifier hs-var">setIdUnfolding</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680354002"><span class="hs-identifier hs-var">unfolding</span></a><span class="hs-special">)</span><span>
</span><a name="line-321"></a><span>                </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>  </span><a href="Vectorise.Monad.Naming.html#mkVectId"><span class="hs-identifier hs-var">mkVectId</span></a><span> </span><a href="#local-6989586621680353999"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621680354004"><span class="hs-identifier hs-var">vty</span></a><span>
</span><a name="line-322"></a><span>
</span><a name="line-323"></a><span>          </span><span class="hs-comment">-- Add the mapping between the plain and vectorised name to the state.</span><span>
</span><a name="line-324"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="Vectorise.Monad.Global.html#defGlobalVar"><span class="hs-identifier hs-var">defGlobalVar</span></a><span> </span><a href="#local-6989586621680353999"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621680354008"><span class="hs-identifier hs-var">var'</span></a><span>
</span><a name="line-325"></a><span>
</span><a name="line-326"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680354008"><span class="hs-identifier hs-var">var'</span></a><span>
</span><a name="line-327"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-328"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-329"></a><span>    </span><a name="local-6989586621680354002"><a href="#local-6989586621680354002"><span class="hs-identifier">unfolding</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680354000"><span class="hs-identifier hs-var">inline</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-330"></a><span>                  </span><a href="Vectorise.Utils.Hoisting.html#Inline"><span class="hs-identifier hs-var">Inline</span></a><span> </span><a name="local-6989586621680354003"><a href="#local-6989586621680354003"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreUnfold.html#mkInlineUnfoldingWithArity"><span class="hs-identifier hs-var">mkInlineUnfoldingWithArity</span></a><span> </span><a href="#local-6989586621680354003"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621680354001"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-331"></a><span>                  </span><a href="Vectorise.Utils.Hoisting.html#DontInline"><span class="hs-identifier hs-var">DontInline</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#noUnfolding"><span class="hs-identifier hs-var">noUnfolding</span></a><span>
</span><a name="line-332"></a><span class="hs-comment">{-
!!!TODO: dfuns and unfoldings:
           -- Do not inline the dfun; instead give it a magic DFunFunfolding
           -- See Note [ClassOp/DFun selection]
           -- See also note [Single-method classes]
        dfun_id_w_fun
           | isNewTyCon class_tc
           = dfun_id `setInlinePragma` alwaysInlinePragma { inl_sat = Just 0 }
           | otherwise
           = dfun_id `setIdUnfolding`  mkDFunUnfolding dfun_ty dfun_args
                     `setInlinePragma` dfunInlinePragma
 -}</span><span>
</span><a name="line-344"></a><span>
</span><a name="line-345"></a><span class="hs-comment">-- |Project out the vectorised version of a binding from some closure, or return the original body</span><span>
</span><a name="line-346"></a><span class="hs-comment">-- if that doesn't work.</span><span>
</span><a name="line-347"></a><span class="hs-comment">--</span><span>
</span><a name="line-348"></a><span class="hs-identifier">tryConvert</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span>       </span><span class="hs-comment">-- ^Name of the original binding (eg @foo@)</span><span>
</span><a name="line-349"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span>       </span><span class="hs-comment">-- ^Name of vectorised version of binding (eg @$vfoo@)</span><span>
</span><a name="line-350"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>  </span><span class="hs-comment">-- ^The original body of the binding.</span><span>
</span><a name="line-351"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Vectorise.Monad.Base.html#VM"><span class="hs-identifier hs-type">VM</span></a><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-352"></a><a name="tryConvert"><a href="Vectorise.html#tryConvert"><span class="hs-identifier">tryConvert</span></a></a><span> </span><a name="local-6989586621680354009"><a href="#local-6989586621680354009"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621680354010"><a href="#local-6989586621680354010"><span class="hs-identifier">vect_var</span></a></a><span> </span><a name="local-6989586621680354011"><a href="#local-6989586621680354011"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-353"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Vectorise.Convert.html#fromVect"><span class="hs-identifier hs-var">fromVect</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-6989586621680354009"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621680354010"><span class="hs-identifier hs-var">vect_var</span></a><span class="hs-special">)</span><span>
</span><a name="line-354"></a><span>    </span><span class="hs-special">`</span><a href="Vectorise.Monad.Base.html#orElseErrV"><span class="hs-identifier hs-var">orElseErrV</span></a><span class="hs-special">`</span><span>
</span><a name="line-355"></a><span>    </span><span class="hs-keyword">do</span><span>
</span><a name="line-356"></a><span>    </span><span class="hs-special">{</span><span> </span><a href="Vectorise.Monad.Base.html#emitVt"><span class="hs-identifier hs-var">emitVt</span></a><span> </span><span class="hs-string">&quot;  Could NOT call vectorised from original version&quot;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680354009"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-6989586621680354009"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span>
</span><a name="line-357"></a><span>    </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680354011"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-358"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-359"></a></pre></body></html>