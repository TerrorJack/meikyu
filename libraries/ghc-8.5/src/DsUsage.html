<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">DsUsage</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-4"></a><span>    </span><span class="hs-comment">-- * Dependency/fingerprinting code (used by MkIface)</span><span>
</span><a name="line-5"></a><span>    </span><a href="DsUsage.html#mkUsageInfo"><span class="hs-identifier hs-var">mkUsageInfo</span></a><span class="hs-special">,</span><span> </span><a href="DsUsage.html#mkUsedNames"><span class="hs-identifier hs-var">mkUsedNames</span></a><span class="hs-special">,</span><span> </span><a href="DsUsage.html#mkDependencies"><span class="hs-identifier hs-var">mkDependencies</span></a><span>
</span><a name="line-6"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="HscTypes.html"><span class="hs-identifier">HscTypes</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnTypes.html"><span class="hs-identifier">TcRnTypes</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="NameSet.html"><span class="hs-identifier">NameSet</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="Module.html"><span class="hs-identifier">Module</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="UniqSet.html"><span class="hs-identifier">UniqSet</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="UniqFM.html"><span class="hs-identifier">UniqFM</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Fingerprint.html"><span class="hs-identifier">Fingerprint</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.IORef.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IORef</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span></a><span> </span><span class="hs-special">(</span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Set</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-comment">{- Note [Module self-dependency]
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

RnNames.calculateAvails asserts the invariant that a module must not occur in
its own dep_orphs or dep_finsts. However, if we aren't careful this can occur
in the presence of hs-boot files: Consider that we have two modules, A and B,
both with hs-boot files,

    A.hs contains a SOURCE import of B B.hs-boot contains a SOURCE import of A
    A.hs-boot declares an orphan instance A.hs defines the orphan instance

In this case, B's dep_orphs will contain A due to its SOURCE import of A.
Consequently, A will contain itself in its imp_orphs due to its import of B.
This fact would end up being recorded in A's interface file. This would then
break the invariant asserted by calculateAvails that a module does not itself in
its dep_orphs. This was the cause of Trac #14128.

-}</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-comment">-- | Extract information from the rename and typecheck phases to produce</span><span>
</span><a name="line-51"></a><span class="hs-comment">-- a dependencies information for the module being compiled.</span><span>
</span><a name="line-52"></a><span class="hs-identifier">mkDependencies</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#TcGblEnv"><span class="hs-identifier hs-type">TcGblEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="HscTypes.html#Dependencies"><span class="hs-identifier hs-type">Dependencies</span></a><span>
</span><a name="line-53"></a><a name="mkDependencies"><a href="DsUsage.html#mkDependencies"><span class="hs-identifier">mkDependencies</span></a></a><span>
</span><a name="line-54"></a><span>          </span><a href="TcRnTypes.html#TcGblEnv"><span class="hs-identifier hs-var">TcGblEnv</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679832411"><a href="#local-6989586621679832411"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-55"></a><span>                    </span><span class="hs-identifier">tcg_imports</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679832412"><a href="#local-6989586621679832412"><span class="hs-identifier">imports</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-56"></a><span>                    </span><span class="hs-identifier">tcg_th_used</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679832413"><a href="#local-6989586621679832413"><span class="hs-identifier">th_var</span></a></a><span>
</span><a name="line-57"></a><span>                  </span><span class="hs-special">}</span><span>
</span><a name="line-58"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-59"></a><span>      </span><span class="hs-comment">-- Template Haskell used?</span><span>
</span><a name="line-60"></a><span>      </span><a name="local-6989586621679832414"><a href="#local-6989586621679832414"><span class="hs-identifier">th_used</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679832413"><span class="hs-identifier hs-var">th_var</span></a><span>
</span><a name="line-61"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679832415"><a href="#local-6989586621679832415"><span class="hs-identifier">dep_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#modDepsElts"><span class="hs-identifier hs-var">modDepsElts</span></a><span> </span><span class="hs-special">(</span><a href="UniqFM.html#delFromUFM"><span class="hs-identifier hs-var">delFromUFM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_dep_mods</span><span> </span><a href="#local-6989586621679832412"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>                                             </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621679832411"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>                </span><span class="hs-comment">-- M.hi-boot can be in the imp_dep_mods, but we must remove</span><span>
</span><a name="line-64"></a><span>                </span><span class="hs-comment">-- it before recording the modules on which this one depends!</span><span>
</span><a name="line-65"></a><span>                </span><span class="hs-comment">-- (We want to retain M.hi-boot in imp_dep_mods so that</span><span>
</span><a name="line-66"></a><span>                </span><span class="hs-comment">--  loadHiBootInterface can see if M's direct imports depend</span><span>
</span><a name="line-67"></a><span>                </span><span class="hs-comment">--  on M.hi-boot, and hence that we should do the hi-boot consistency</span><span>
</span><a name="line-68"></a><span>                </span><span class="hs-comment">--  check.)</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span>          </span><a name="local-6989586621679832416"><a href="#local-6989586621679832416"><span class="hs-identifier">dep_orphs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621679832411"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_orphs</span><span> </span><a href="#local-6989586621679832412"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span>                </span><span class="hs-comment">-- We must also remove self-references from imp_orphs. See</span><span>
</span><a name="line-72"></a><span>                </span><span class="hs-comment">-- Note [Module self-dependency]</span><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span>          </span><a name="local-6989586621679832417"><a href="#local-6989586621679832417"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679832414"><span class="hs-identifier hs-var">th_used</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#insert"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span></a><span> </span><span class="hs-special">(</span><a href="Module.html#toInstalledUnitId"><span class="hs-identifier hs-var">toInstalledUnitId</span></a><span> </span><a href="Module.html#thUnitId"><span class="hs-identifier hs-var">thUnitId</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_dep_pkgs</span><span> </span><a href="#local-6989586621679832412"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">imp_dep_pkgs</span><span> </span><a href="#local-6989586621679832412"><span class="hs-identifier hs-var">imports</span></a><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span>          </span><span class="hs-comment">-- Set the packages required to be Safe according to Safe Haskell.</span><span>
</span><a name="line-78"></a><span>          </span><span class="hs-comment">-- See Note [RnNames . Tracking Trust Transitively]</span><span>
</span><a name="line-79"></a><span>          </span><a name="local-6989586621679832418"><a href="#local-6989586621679832418"><span class="hs-identifier">sorted_pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#sort"><span class="hs-identifier hs-var">sort</span></a><span> </span><span class="hs-special">(</span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#toList"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toList</span></a><span> </span><a href="#local-6989586621679832417"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>          </span><a name="local-6989586621679832419"><a href="#local-6989586621679832419"><span class="hs-identifier">trust_pkgs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">imp_trust_pkgs</span><span> </span><a href="#local-6989586621679832412"><span class="hs-identifier hs-var">imports</span></a><span>
</span><a name="line-81"></a><span>          </span><a name="local-6989586621679832420"><a href="#local-6989586621679832420"><span class="hs-identifier">dep_pkgs'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679832421"><a href="#local-6989586621679832421"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679832421"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679832421"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#member"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">member</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679832419"><span class="hs-identifier hs-var">trust_pkgs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679832418"><span class="hs-identifier hs-var">sorted_pkgs</span></a><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span>      </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="HscTypes.html#Deps"><span class="hs-identifier hs-var">Deps</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dep_mods</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832415"><span class="hs-identifier hs-var">dep_mods</span></a><span class="hs-special">,</span><span>
</span><a name="line-84"></a><span>                    </span><span class="hs-identifier">dep_pkgs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832420"><span class="hs-identifier hs-var">dep_pkgs'</span></a><span class="hs-special">,</span><span>
</span><a name="line-85"></a><span>                    </span><span class="hs-identifier">dep_orphs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832416"><span class="hs-identifier hs-var">dep_orphs</span></a><span class="hs-special">,</span><span>
</span><a name="line-86"></a><span>                    </span><span class="hs-identifier">dep_finsts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a><span> </span><a href="Module.html#stableModuleCmp"><span class="hs-identifier hs-var">stableModuleCmp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_finsts</span><span> </span><a href="#local-6989586621679832412"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-87"></a><span>                    </span><span class="hs-comment">-- sort to get into canonical order</span><span>
</span><a name="line-88"></a><span>                    </span><span class="hs-comment">-- NB. remember to use lexicographic ordering</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-identifier">mkUsedNames</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#TcGblEnv"><span class="hs-identifier hs-type">TcGblEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NameSet.html#NameSet"><span class="hs-identifier hs-type">NameSet</span></a><span>
</span><a name="line-91"></a><a name="mkUsedNames"><a href="DsUsage.html#mkUsedNames"><span class="hs-identifier">mkUsedNames</span></a></a><span> </span><a href="TcRnTypes.html#TcGblEnv"><span class="hs-identifier hs-var">TcGblEnv</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_dus</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679832422"><a href="#local-6989586621679832422"><span class="hs-identifier">dus</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="NameSet.html#allUses"><span class="hs-identifier hs-var">allUses</span></a><span> </span><a href="#local-6989586621679832422"><span class="hs-identifier hs-var">dus</span></a><span>
</span><a name="line-92"></a><span>
</span><a name="line-93"></a><span class="hs-identifier">mkUsageInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HscTypes.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HscTypes.html#ImportedMods"><span class="hs-identifier hs-type">ImportedMods</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NameSet.html#NameSet"><span class="hs-identifier hs-type">NameSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Fingerprint.Type.html#Fingerprint"><span class="hs-identifier hs-type">Fingerprint</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><a href="HscTypes.html#Usage"><span class="hs-identifier hs-type">Usage</span></a><span class="hs-special">]</span><span>
</span><a name="line-94"></a><a name="mkUsageInfo"><a href="DsUsage.html#mkUsageInfo"><span class="hs-identifier">mkUsageInfo</span></a></a><span> </span><a name="local-6989586621679832423"><a href="#local-6989586621679832423"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679832424"><a href="#local-6989586621679832424"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621679832425"><a href="#local-6989586621679832425"><span class="hs-identifier">dir_imp_mods</span></a></a><span> </span><a name="local-6989586621679832426"><a href="#local-6989586621679832426"><span class="hs-identifier">used_names</span></a></a><span> </span><a name="local-6989586621679832427"><a href="#local-6989586621679832427"><span class="hs-identifier">dependent_files</span></a></a><span> </span><a name="local-6989586621679832428"><a href="#local-6989586621679832428"><span class="hs-identifier">merged</span></a></a><span>
</span><a name="line-95"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-96"></a><span>    </span><a name="local-6989586621679832429"><a href="#local-6989586621679832429"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscTypes.html#hscEPS"><span class="hs-identifier hs-var">hscEPS</span></a><span> </span><a href="#local-6989586621679832423"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-97"></a><span>    </span><a name="local-6989586621679832430"><a href="#local-6989586621679832430"><span class="hs-identifier">hashes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Fingerprint.html#getFileHash"><span class="hs-identifier hs-var">getFileHash</span></a><span> </span><a href="#local-6989586621679832427"><span class="hs-identifier hs-var">dependent_files</span></a><span>
</span><a name="line-98"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679832431"><a href="#local-6989586621679832431"><span class="hs-identifier">mod_usages</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUsage.html#mk_mod_usage_info"><span class="hs-identifier hs-var">mk_mod_usage_info</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_PIT</span><span> </span><a href="#local-6989586621679832429"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679832423"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621679832424"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-99"></a><span>                                       </span><a href="#local-6989586621679832425"><span class="hs-identifier hs-var">dir_imp_mods</span></a><span> </span><a href="#local-6989586621679832426"><span class="hs-identifier hs-var">used_names</span></a><span>
</span><a name="line-100"></a><span>        </span><a name="local-6989586621679832432"><a href="#local-6989586621679832432"><span class="hs-identifier">usages</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832431"><span class="hs-identifier hs-var">mod_usages</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="HscTypes.html#UsageFile"><span class="hs-identifier hs-var">UsageFile</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">usg_file_path</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832433"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-101"></a><span>                                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">usg_file_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832434"><span class="hs-identifier hs-var">hash</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-102"></a><span>                               </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679832433"><a href="#local-6989586621679832433"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679832434"><a href="#local-6989586621679832434"><span class="hs-identifier">hash</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span> </span><a href="#local-6989586621679832427"><span class="hs-identifier hs-var">dependent_files</span></a><span> </span><a href="#local-6989586621679832430"><span class="hs-identifier hs-var">hashes</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-103"></a><span>                            </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="HscTypes.html#UsageMergedRequirement"><span class="hs-identifier hs-var">UsageMergedRequirement</span></a><span>
</span><a name="line-104"></a><span>                                    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">usg_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832435"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-105"></a><span>                                      </span><span class="hs-identifier">usg_mod_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832436"><span class="hs-identifier hs-var">hash</span></a><span>
</span><a name="line-106"></a><span>                                    </span><span class="hs-special">}</span><span>
</span><a name="line-107"></a><span>                               </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679832435"><a href="#local-6989586621679832435"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679832436"><a href="#local-6989586621679832436"><span class="hs-identifier">hash</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679832428"><span class="hs-identifier hs-var">merged</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-108"></a><span>    </span><a href="#local-6989586621679832432"><span class="hs-identifier hs-var">usages</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#seqList"><span class="hs-identifier hs-var">seqList</span></a><span class="hs-special">`</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679832432"><span class="hs-identifier hs-var">usages</span></a><span>
</span><a name="line-109"></a><span>    </span><span class="hs-comment">-- seq the list of Usages returned: occasionally these</span><span>
</span><a name="line-110"></a><span>    </span><span class="hs-comment">-- don't get evaluated for a while and we can end up hanging on to</span><span>
</span><a name="line-111"></a><span>    </span><span class="hs-comment">-- the entire collection of Ifaces.</span><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span class="hs-identifier">mk_mod_usage_info</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HscTypes.html#PackageIfaceTable"><span class="hs-identifier hs-type">PackageIfaceTable</span></a><span>
</span><a name="line-114"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HscTypes.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a><span>
</span><a name="line-115"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span>
</span><a name="line-116"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HscTypes.html#ImportedMods"><span class="hs-identifier hs-type">ImportedMods</span></a><span>
</span><a name="line-117"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NameSet.html#NameSet"><span class="hs-identifier hs-type">NameSet</span></a><span>
</span><a name="line-118"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HscTypes.html#Usage"><span class="hs-identifier hs-type">Usage</span></a><span class="hs-special">]</span><span>
</span><a name="line-119"></a><a name="mk_mod_usage_info"><a href="DsUsage.html#mk_mod_usage_info"><span class="hs-identifier">mk_mod_usage_info</span></a></a><span> </span><a name="local-6989586621679832437"><a href="#local-6989586621679832437"><span class="hs-identifier">pit</span></a></a><span> </span><a name="local-6989586621679832438"><a href="#local-6989586621679832438"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679832439"><a href="#local-6989586621679832439"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621679832440"><a href="#local-6989586621679832440"><span class="hs-identifier">direct_imports</span></a></a><span> </span><a name="local-6989586621679832441"><a href="#local-6989586621679832441"><span class="hs-identifier">used_names</span></a></a><span>
</span><a name="line-120"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#mapMaybe"><span class="hs-identifier hs-var">mapMaybe</span></a><span> </span><a href="#local-6989586621679832450"><span class="hs-identifier hs-var">mkUsage</span></a><span> </span><a href="#local-6989586621679832448"><span class="hs-identifier hs-var">usage_mods</span></a><span>
</span><a name="line-121"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-122"></a><span>    </span><a name="local-6989586621679832442"><a href="#local-6989586621679832442"><span class="hs-identifier">hpt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621679832438"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-123"></a><span>    </span><a name="local-6989586621679832443"><a href="#local-6989586621679832443"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621679832438"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-124"></a><span>    </span><a name="local-6989586621679832444"><a href="#local-6989586621679832444"><span class="hs-identifier">this_pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DynFlags.html#thisPackage"><span class="hs-identifier hs-var">thisPackage</span></a><span> </span><a href="#local-6989586621679832443"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span>    </span><a name="local-6989586621679832445"><a href="#local-6989586621679832445"><span class="hs-identifier">used_mods</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Module.html#moduleEnvKeys"><span class="hs-identifier hs-var">moduleEnvKeys</span></a><span> </span><a href="#local-6989586621679832449"><span class="hs-identifier hs-var">ent_map</span></a><span>
</span><a name="line-127"></a><span>    </span><a name="local-6989586621679832446"><a href="#local-6989586621679832446"><span class="hs-identifier">dir_imp_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Module.html#moduleEnvKeys"><span class="hs-identifier hs-var">moduleEnvKeys</span></a><span> </span><a href="#local-6989586621679832440"><span class="hs-identifier hs-var">direct_imports</span></a><span>
</span><a name="line-128"></a><span>    </span><a name="local-6989586621679832447"><a href="#local-6989586621679832447"><span class="hs-identifier">all_mods</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832445"><span class="hs-identifier hs-var">used_mods</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#notElem"><span class="hs-identifier hs-var">notElem</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679832445"><span class="hs-identifier hs-var">used_mods</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679832446"><span class="hs-identifier hs-var">dir_imp_mods</span></a><span>
</span><a name="line-129"></a><span>    </span><a name="local-6989586621679832448"><a href="#local-6989586621679832448"><span class="hs-identifier">usage_mods</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a><span> </span><a href="Module.html#stableModuleCmp"><span class="hs-identifier hs-var">stableModuleCmp</span></a><span> </span><a href="#local-6989586621679832447"><span class="hs-identifier hs-var">all_mods</span></a><span>
</span><a name="line-130"></a><span>                        </span><span class="hs-comment">-- canonical order is imported, to avoid interface-file</span><span>
</span><a name="line-131"></a><span>                        </span><span class="hs-comment">-- wobblage.</span><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span>    </span><span class="hs-comment">-- ent_map groups together all the things imported and used</span><span>
</span><a name="line-134"></a><span>    </span><span class="hs-comment">-- from a particular module</span><span>
</span><a name="line-135"></a><span>    </span><span class="hs-identifier">ent_map</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Module.html#ModuleEnv"><span class="hs-identifier hs-type">ModuleEnv</span></a><span> </span><span class="hs-special">[</span><a href="OccName.html#OccName"><span class="hs-identifier hs-type">OccName</span></a><span class="hs-special">]</span><span>
</span><a name="line-136"></a><span>    </span><a name="local-6989586621679832449"><a href="#local-6989586621679832449"><span class="hs-identifier">ent_map</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="UniqSet.html#nonDetFoldUniqSet"><span class="hs-identifier hs-var">nonDetFoldUniqSet</span></a><span> </span><a href="#local-6989586621679832451"><span class="hs-identifier hs-var">add_mv</span></a><span> </span><a href="Module.html#emptyModuleEnv"><span class="hs-identifier hs-var">emptyModuleEnv</span></a><span> </span><a href="#local-6989586621679832441"><span class="hs-identifier hs-var">used_names</span></a><span>
</span><a name="line-137"></a><span>     </span><span class="hs-comment">-- nonDetFoldUFM is OK here. If you follow the logic, we sort by OccName</span><span>
</span><a name="line-138"></a><span>     </span><span class="hs-comment">-- in ent_hashs</span><span>
</span><a name="line-139"></a><span>     </span><span class="hs-keyword">where</span><span>
</span><a name="line-140"></a><span>      </span><a name="local-6989586621679832451"><a href="#local-6989586621679832451"><span class="hs-identifier">add_mv</span></a></a><span> </span><a name="local-6989586621679832452"><a href="#local-6989586621679832452"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679832453"><a href="#local-6989586621679832453"><span class="hs-identifier">mv_map</span></a></a><span>
</span><a name="line-141"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="Name.html#isWiredInName"><span class="hs-identifier hs-var">isWiredInName</span></a><span> </span><a href="#local-6989586621679832452"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832453"><span class="hs-identifier hs-var">mv_map</span></a><span>  </span><span class="hs-comment">-- ignore wired-in names</span><span>
</span><a name="line-142"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-143"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Name.html#nameModule_maybe"><span class="hs-identifier hs-var">nameModule_maybe</span></a><span> </span><a href="#local-6989586621679832452"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-144"></a><span>             </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isSystemName</span><span> </span><a href="Name.html#isSystemName"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="Name.html#isSystemName"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">mv_map</span><span>
</span><a name="line-145"></a><span>                </span><span class="hs-comment">-- See Note [Internal used_names]</span><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span>             </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679832455"><a href="#local-6989586621679832455"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-148"></a><span>                </span><span class="hs-comment">-- See Note [Identity versus semantic module]</span><span>
</span><a name="line-149"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679832456"><a href="#local-6989586621679832456"><span class="hs-identifier">mod'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Module.html#isHoleModule"><span class="hs-identifier hs-var">isHoleModule</span></a><span> </span><a href="#local-6989586621679832455"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-150"></a><span>                            </span><span class="hs-keyword">then</span><span> </span><a href="Module.html#mkModule"><span class="hs-identifier hs-var">mkModule</span></a><span> </span><a href="#local-6989586621679832444"><span class="hs-identifier hs-var">this_pkg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621679832455"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span>                            </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679832455"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-152"></a><span>                </span><span class="hs-comment">-- This lambda function is really just a</span><span>
</span><a name="line-153"></a><span>                </span><span class="hs-comment">-- specialised (++); originally came about to</span><span>
</span><a name="line-154"></a><span>                </span><span class="hs-comment">-- avoid quadratic behaviour (trac #2680)</span><span>
</span><a name="line-155"></a><span>                </span><span class="hs-keyword">in</span><span> </span><a href="Module.html#extendModuleEnvWith"><span class="hs-identifier hs-var">extendModuleEnvWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679832457"><a href="#local-6989586621679832457"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679832454"><span class="hs-identifier hs-var">occ</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679832457"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679832453"><span class="hs-identifier hs-var">mv_map</span></a><span> </span><a href="#local-6989586621679832456"><span class="hs-identifier hs-var">mod'</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679832454"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">]</span><span>
</span><a name="line-156"></a><span>            </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679832454"><a href="#local-6989586621679832454"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#nameOccName"><span class="hs-identifier hs-var">nameOccName</span></a><span> </span><a href="#local-6989586621679832452"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span>    </span><span class="hs-comment">-- We want to create a Usage for a home module if</span><span>
</span><a name="line-159"></a><span>    </span><span class="hs-comment">--  a) we used something from it; has something in used_names</span><span>
</span><a name="line-160"></a><span>    </span><span class="hs-comment">--  b) we imported it, even if we used nothing from it</span><span>
</span><a name="line-161"></a><span>    </span><span class="hs-comment">--     (need to recompile if its export list changes: export_fprint)</span><span>
</span><a name="line-162"></a><span>    </span><span class="hs-identifier">mkUsage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="HscTypes.html#Usage"><span class="hs-identifier hs-type">Usage</span></a><span>
</span><a name="line-163"></a><span>    </span><a name="local-6989586621679832450"><a href="#local-6989586621679832450"><span class="hs-identifier">mkUsage</span></a></a><span> </span><a name="local-6989586621679832458"><a href="#local-6989586621679832458"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-164"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isNothing"><span class="hs-identifier hs-var">isNothing</span></a><span> </span><a href="#local-6989586621679832459"><span class="hs-identifier hs-var">maybe_iface</span></a><span>           </span><span class="hs-comment">-- We can't depend on it if we didn't</span><span>
</span><a name="line-165"></a><span>                                        </span><span class="hs-comment">-- load its interface.</span><span>
</span><a name="line-166"></a><span>      </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679832458"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679832439"><span class="hs-identifier hs-var">this_mod</span></a><span>                </span><span class="hs-comment">-- We don't care about usages of</span><span>
</span><a name="line-167"></a><span>                                        </span><span class="hs-comment">-- things in *this* module</span><span>
</span><a name="line-168"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621679832458"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621679832444"><span class="hs-identifier hs-var">this_pkg</span></a><span>
</span><a name="line-171"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="HscTypes.html#UsagePackageModule"><span class="hs-identifier hs-var">UsagePackageModule</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">usg_mod</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832458"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-172"></a><span>                                 </span><span class="hs-identifier">usg_mod_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832463"><span class="hs-identifier hs-var">mod_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-173"></a><span>                                 </span><span class="hs-identifier">usg_safe</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832467"><span class="hs-identifier hs-var">imp_safe</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-174"></a><span>        </span><span class="hs-comment">-- for package modules, we record the module hash only</span><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621679832468"><span class="hs-identifier hs-var">used_occs</span></a><span>
</span><a name="line-177"></a><span>          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isNothing"><span class="hs-identifier hs-var">isNothing</span></a><span> </span><a href="#local-6989586621679832464"><span class="hs-identifier hs-var">export_hash</span></a><span>
</span><a name="line-178"></a><span>          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679832466"><span class="hs-identifier hs-var">is_direct_import</span></a><span>
</span><a name="line-179"></a><span>          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679832461"><span class="hs-identifier hs-var">finsts_mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>                 </span><span class="hs-comment">-- Record no usage info</span><span>
</span><a name="line-181"></a><span>        </span><span class="hs-comment">-- for directly-imported modules, we always want to record a usage</span><span>
</span><a name="line-182"></a><span>        </span><span class="hs-comment">-- on the orphan hash.  This is what triggers a recompilation if</span><span>
</span><a name="line-183"></a><span>        </span><span class="hs-comment">-- an orphan is added or removed somewhere below us in the future.</span><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-186"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="HscTypes.html#UsageHomeModule"><span class="hs-identifier hs-var">UsageHomeModule</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-187"></a><span>                      </span><span class="hs-identifier">usg_mod_name</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621679832458"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-188"></a><span>                      </span><span class="hs-identifier">usg_mod_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832463"><span class="hs-identifier hs-var">mod_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-189"></a><span>                      </span><span class="hs-identifier">usg_exports</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832464"><span class="hs-identifier hs-var">export_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-190"></a><span>                      </span><span class="hs-identifier">usg_entities</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toList</span></a><span> </span><a href="#local-6989586621679832469"><span class="hs-identifier hs-var">ent_hashs</span></a><span class="hs-special">,</span><span>
</span><a name="line-191"></a><span>                      </span><span class="hs-identifier">usg_safe</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832467"><span class="hs-identifier hs-var">imp_safe</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-192"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-193"></a><span>        </span><a name="local-6989586621679832459"><a href="#local-6989586621679832459"><span class="hs-identifier">maybe_iface</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="HscTypes.html#lookupIfaceByModule"><span class="hs-identifier hs-var">lookupIfaceByModule</span></a><span> </span><a href="#local-6989586621679832443"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679832442"><span class="hs-identifier hs-var">hpt</span></a><span> </span><a href="#local-6989586621679832437"><span class="hs-identifier hs-var">pit</span></a><span> </span><a href="#local-6989586621679832458"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-194"></a><span>                </span><span class="hs-comment">-- In one-shot mode, the interfaces for home-package</span><span>
</span><a name="line-195"></a><span>                </span><span class="hs-comment">-- modules accumulate in the PIT not HPT.  Sigh.</span><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span>        </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679832460"><a href="#local-6989586621679832460"><span class="hs-identifier">iface</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832459"><span class="hs-identifier hs-var">maybe_iface</span></a><span>
</span><a name="line-198"></a><span>        </span><a name="local-6989586621679832461"><a href="#local-6989586621679832461"><span class="hs-identifier">finsts_mod</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_finsts</span><span>    </span><a href="#local-6989586621679832460"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-199"></a><span>        </span><a name="local-6989586621679832462"><a href="#local-6989586621679832462"><span class="hs-identifier">hash_env</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_hash_fn</span><span>   </span><a href="#local-6989586621679832460"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-200"></a><span>        </span><a name="local-6989586621679832463"><a href="#local-6989586621679832463"><span class="hs-identifier">mod_hash</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_mod_hash</span><span>  </span><a href="#local-6989586621679832460"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-201"></a><span>        </span><a name="local-6989586621679832464"><a href="#local-6989586621679832464"><span class="hs-identifier">export_hash</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679832471"><span class="hs-identifier hs-var">depend_on_exports</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_exp_hash</span><span> </span><a href="#local-6989586621679832460"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span>        </span><a name="local-6989586621679832465"><a href="#local-6989586621679832465"><span class="hs-identifier">by_is_safe</span></a></a><span> </span><span class="hs-special">(</span><a href="HscTypes.html#ImportedByUser"><span class="hs-identifier hs-var">ImportedByUser</span></a><span> </span><a name="local-6989586621679832472"><a href="#local-6989586621679832472"><span class="hs-identifier">imv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">imv_is_safe</span><span> </span><a href="#local-6989586621679832472"><span class="hs-identifier hs-var">imv</span></a><span>
</span><a name="line-205"></a><span>        </span><span class="hs-identifier">by_is_safe</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-206"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679832466"><a href="#local-6989586621679832466"><span class="hs-identifier">is_direct_import</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679832467"><a href="#local-6989586621679832467"><span class="hs-identifier">imp_safe</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-207"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Module.html#lookupModuleEnv"><span class="hs-identifier hs-var">lookupModuleEnv</span></a><span> </span><a href="#local-6989586621679832440"><span class="hs-identifier hs-var">direct_imports</span></a><span> </span><a href="#local-6989586621679832458"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-208"></a><span>                </span><span class="hs-comment">-- ezyang: I'm not sure if any is the correct</span><span>
</span><a name="line-209"></a><span>                </span><span class="hs-comment">-- metric here. If safety was guaranteed to be uniform</span><span>
</span><a name="line-210"></a><span>                </span><span class="hs-comment">-- across all imports, why did the old code only look</span><span>
</span><a name="line-211"></a><span>                </span><span class="hs-comment">-- at the first import?</span><span>
</span><a name="line-212"></a><span>                </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679832473"><a href="#local-6989586621679832473"><span class="hs-identifier">bys</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a><span> </span><a href="#local-6989586621679832465"><span class="hs-identifier hs-var">by_is_safe</span></a><span> </span><a href="#local-6989586621679832473"><span class="hs-identifier hs-var">bys</span></a><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>                </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="DynFlags.html#safeImplicitImpsReq"><span class="hs-identifier hs-var">safeImplicitImpsReq</span></a><span> </span><a href="#local-6989586621679832443"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>                </span><span class="hs-comment">-- Nothing case is for references to entities which were</span><span>
</span><a name="line-215"></a><span>                </span><span class="hs-comment">-- not directly imported (NB: the &quot;implicit&quot; Prelude import</span><span>
</span><a name="line-216"></a><span>                </span><span class="hs-comment">-- counts as directly imported!  An entity is not directly</span><span>
</span><a name="line-217"></a><span>                </span><span class="hs-comment">-- imported if, e.g., we got a reference to it from a</span><span>
</span><a name="line-218"></a><span>                </span><span class="hs-comment">-- reexport of another module.)</span><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a><span>        </span><a name="local-6989586621679832468"><a href="#local-6989586621679832468"><span class="hs-identifier">used_occs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Module.html#lookupModuleEnv"><span class="hs-identifier hs-var">lookupModuleEnv</span></a><span> </span><a href="#local-6989586621679832449"><span class="hs-identifier hs-var">ent_map</span></a><span> </span><a href="#local-6989586621679832458"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span>        </span><span class="hs-comment">-- Making a Map here ensures that (a) we remove duplicates</span><span>
</span><a name="line-223"></a><span>        </span><span class="hs-comment">-- when we have usages on several subordinates of a single parent,</span><span>
</span><a name="line-224"></a><span>        </span><span class="hs-comment">-- and (b) that the usages emerge in a canonical order, which</span><span>
</span><a name="line-225"></a><span>        </span><span class="hs-comment">-- is why we use Map rather than OccEnv: Map works</span><span>
</span><a name="line-226"></a><span>        </span><span class="hs-comment">-- using Ord on the OccNames, which is a lexicographic ordering.</span><span>
</span><a name="line-227"></a><span>        </span><span class="hs-identifier">ent_hashs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a><span> </span><a href="OccName.html#OccName"><span class="hs-identifier hs-type">OccName</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Fingerprint.Type.html#Fingerprint"><span class="hs-identifier hs-type">Fingerprint</span></a><span>
</span><a name="line-228"></a><span>        </span><a name="local-6989586621679832469"><a href="#local-6989586621679832469"><span class="hs-identifier">ent_hashs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#fromList"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-6989586621679832470"><span class="hs-identifier hs-var">lookup_occ</span></a><span> </span><a href="#local-6989586621679832468"><span class="hs-identifier hs-var">used_occs</span></a><span class="hs-special">)</span><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span>        </span><a name="local-6989586621679832470"><a href="#local-6989586621679832470"><span class="hs-identifier">lookup_occ</span></a></a><span> </span><a name="local-6989586621679832474"><a href="#local-6989586621679832474"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-231"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679832462"><span class="hs-identifier hs-var">hash_env</span></a><span> </span><a href="#local-6989586621679832474"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-232"></a><span>                </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;mkUsage&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679832458"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679832474"><span class="hs-identifier hs-var">occ</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621679832441"><span class="hs-identifier hs-var">used_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-233"></a><span>                </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679832475"><a href="#local-6989586621679832475"><span class="hs-identifier">r</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679832475"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-234"></a><span>
</span><a name="line-235"></a><span>        </span><a name="local-6989586621679832471"><a href="#local-6989586621679832471"><span class="hs-identifier">depend_on_exports</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679832466"><span class="hs-identifier hs-var">is_direct_import</span></a><span>
</span><a name="line-236"></a><span>        </span><span class="hs-comment">{- True
              Even if we used 'import M ()', we have to register a
              usage on the export list because we are sensitive to
              changes in orphan instances/rules.
           False
              In GHC 6.8.x we always returned true, and in
              fact it recorded a dependency on *all* the
              modules underneath in the dependency tree.  This
              happens to make orphans work right, but is too
              expensive: it'll read too many interface files.
              The 'isNothing maybe_iface' check above saved us
              from generating many of these usages (at least in
              one-shot mode), but that's even more bogus!
        -}</span><span>
</span><a name="line-250"></a></pre></body></html>